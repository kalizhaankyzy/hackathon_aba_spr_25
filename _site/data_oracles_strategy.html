<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Group Data Oracles">

<title>Vortex–Sentiment Adaptive Volatility (VSAV) Strategy – Vortex Sentiment Adaptive Volatility VSAV Strategy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Vortex Sentiment Adaptive Volatility VSAV Strategy</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./data_oracles_strategy.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#importing-necessary-libraries-for-analysis" id="toc-importing-necessary-libraries-for-analysis" class="nav-link active" data-scroll-target="#importing-necessary-libraries-for-analysis">Importing Necessary Libraries for Analysis</a></li>
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">Data Collection</a>
  <ul class="collapse">
  <li><a href="#fetch-daily-ohlcv-data" id="toc-fetch-daily-ohlcv-data" class="nav-link" data-scroll-target="#fetch-daily-ohlcv-data">Fetch daily OHLCV data</a></li>
  <li><a href="#fetch-sentiment-scores-from-the-api" id="toc-fetch-sentiment-scores-from-the-api" class="nav-link" data-scroll-target="#fetch-sentiment-scores-from-the-api">Fetch sentiment scores from the API</a></li>
  </ul></li>
  <li><a href="#indicator-calculation" id="toc-indicator-calculation" class="nav-link" data-scroll-target="#indicator-calculation">Indicator Calculation</a>
  <ul class="collapse">
  <li><a href="#compute-vi-and-vi-" id="toc-compute-vi-and-vi-" class="nav-link" data-scroll-target="#compute-vi-and-vi-">Compute VI+ and VI-</a></li>
  <li><a href="#calculate-volume-weighted-sentiment" id="toc-calculate-volume-weighted-sentiment" class="nav-link" data-scroll-target="#calculate-volume-weighted-sentiment">Calculate Volume-Weighted Sentiment</a></li>
  <li><a href="#derive-atr-10-for-volatility-adjustments" id="toc-derive-atr-10-for-volatility-adjustments" class="nav-link" data-scroll-target="#derive-atr-10-for-volatility-adjustments">Derive ATR (10) for Volatility Adjustments</a></li>
  </ul></li>
  <li><a href="#tesla-analysis-results" id="toc-tesla-analysis-results" class="nav-link" data-scroll-target="#tesla-analysis-results">Tesla Analysis Results</a></li>
  <li><a href="#xly-analysis-results" id="toc-xly-analysis-results" class="nav-link" data-scroll-target="#xly-analysis-results">XLY Analysis Results</a>
  <ul class="collapse">
  <li><a href="#without-sentiment-code" id="toc-without-sentiment-code" class="nav-link" data-scroll-target="#without-sentiment-code">Without sentiment code</a></li>
  </ul></li>
  <li><a href="#spy-analysis-results" id="toc-spy-analysis-results" class="nav-link" data-scroll-target="#spy-analysis-results">SPY Analysis Results</a></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization">Optimization</a></li>
  <li><a href="#peer-comparison-apple-analysis-results" id="toc-peer-comparison-apple-analysis-results" class="nav-link" data-scroll-target="#peer-comparison-apple-analysis-results">Peer Comparison: Apple Analysis Results</a>
  <ul class="collapse">
  <li><a href="#without-sentiment" id="toc-without-sentiment" class="nav-link" data-scroll-target="#without-sentiment">Without Sentiment</a></li>
  </ul></li>
  <li><a href="#vi-plots" id="toc-vi-plots" class="nav-link" data-scroll-target="#vi-plots">VI Plots</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Vortex–Sentiment Adaptive Volatility (VSAV) Strategy</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Group Data Oracles </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Boston University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="importing-necessary-libraries-for-analysis" class="level2">
<h2 class="anchored" data-anchor-id="importing-necessary-libraries-for-analysis">Importing Necessary Libraries for Analysis</h2>
<div id="cell-2" class="cell" data-execution_count="1401">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf  <span class="co"># For downloading financial data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np      <span class="co"># For numerical operations</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd     <span class="co"># For data manipulation</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests <span class="co"># For downloading the API data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px <span class="co"># Import the Plotly Express module for interactive visualization</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vectorbt <span class="im">as</span> vbt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-collection" class="level2">
<h2 class="anchored" data-anchor-id="data-collection">Data Collection</h2>
<section id="fetch-daily-ohlcv-data" class="level3">
<h3 class="anchored" data-anchor-id="fetch-daily-ohlcv-data">Fetch daily OHLCV data</h3>
<div id="cell-5" class="cell" data-outputid="d2b18763-b874-471e-fd06-1cc141c449e3" data-execution_count="1402">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for the TSLA, XLY, and SPY tickers is retrieved from the Yahoo Finance library, covering the period from January 1, 2019, </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to March 5, 2025.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> yf.download(<span class="st">'TSLA'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>) </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> yf.download(<span class="st">'XLY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> yf.download(<span class="st">'SPY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-outputid="ffaa84e9-b819-44a7-f26e-e2a55a32d83e" data-execution_count="1403">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the TSLA DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>tsla.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column          Non-Null Count  Dtype  
---  ------          --------------  -----  
 0   (Close, TSLA)   1551 non-null   float64
 1   (High, TSLA)    1551 non-null   float64
 2   (Low, TSLA)     1551 non-null   float64
 3   (Open, TSLA)    1551 non-null   float64
 4   (Volume, TSLA)  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
<div id="cell-7" class="cell" data-outputid="6e7bc69d-4e6d-421f-99e7-c4ad1fb3ad76" data-execution_count="1404">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the XLY DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>xly.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   (Close, XLY)   1551 non-null   float64
 1   (High, XLY)    1551 non-null   float64
 2   (Low, XLY)     1551 non-null   float64
 3   (Open, XLY)    1551 non-null   float64
 4   (Volume, XLY)  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="1405">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the SPY DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>spy.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   (Close, SPY)   1551 non-null   float64
 1   (High, SPY)    1551 non-null   float64
 2   (Low, SPY)     1551 non-null   float64
 3   (Open, SPY)    1551 non-null   float64
 4   (Volume, SPY)  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
</section>
<section id="fetch-sentiment-scores-from-the-api" class="level3">
<h3 class="anchored" data-anchor-id="fetch-sentiment-scores-from-the-api">Fetch sentiment scores from the API</h3>
<div id="cell-10" class="cell" data-execution_count="1406">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines the API endpoint URL for retrieving news sentiment data related to Tesla (TSLA) </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from the Alpha Vantage service. The query specifies the function type, date range, result limit, </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># targeted ticker symbol, and a valid API key.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">###url = 'https://www.alphavantage.co/query?function=NEWS_SENTIMENT&amp;date_from=20250101T0130&amp;date_to=20250301T0130&amp;limit=1000&amp;tickers=TSLA&amp;apikey=PNM5EHRALIOT1CKJ'</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sends a GET request to the specified URL to initiate the API call.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">###response = requests.get(url)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluates whether the API call was successful based on the HTTP response status code.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">###if response.status_code == 200:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parses the JSON response and extracts the 'feed' section containing sentiment data.</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">###sentiment_data = response.json()</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Converts the extracted sentiment feed into a DataFrame for further analysis or visualization.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">###sentiment_df = pd.DataFrame(sentiment_data['feed']) </span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Displays the first five rows of the sentiment DataFrame to provide an overview of the retrieved content.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">###print(sentiment_df.head())</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">####else:</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prints an error message if the API request was unsuccessful.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">###print("API call failed:", response.status_code)</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Independently parses the full JSON response and prints its contents for inspection or debugging purposes.</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">###sentiment_json = response.json()</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">###print(sentiment_json)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="indicator-calculation" class="level2">
<h2 class="anchored" data-anchor-id="indicator-calculation">Indicator Calculation</h2>
<section id="compute-vi-and-vi-" class="level3">
<h3 class="anchored" data-anchor-id="compute-vi-and-vi-">Compute VI+ and VI-</h3>
<div id="cell-13" class="cell" data-execution_count="1407">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines a function to calculate the Vortex Indicator (VI) for a given DataFrame and ticker symbol.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The calculation uses a default lookback period of 14 days unless specified otherwise.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_vortex(df, value, n<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extracts the high, low, and close price series for the specified ticker.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> df[(<span class="st">"High"</span>, value)]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    low <span class="op">=</span> df[(<span class="st">"Low"</span>, value)]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    close <span class="op">=</span> df[(<span class="st">"Close"</span>, value)]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculates the Vortex Movement values:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VM+ = absolute difference between today's high and yesterday's low</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VM− = absolute difference between today's low and yesterday's high</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    vm_plus <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low.shift(<span class="dv">1</span>))     <span class="co"># |Today's High – Yesterday’s Low|</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    vm_minus <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> high.shift(<span class="dv">1</span>))    <span class="co"># |Today's Low – Yesterday’s High|</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Computes the True Range (TR) as the maximum of:</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - High - Low</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Absolute difference between High and Previous Close</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Absolute difference between Low and Previous Close</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        high <span class="op">-</span> low,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>)),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Applies a rolling window to compute the n-period sum of VM+ and VM− values</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and the corresponding True Range values.</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    sum_vm_plus <span class="op">=</span> vm_plus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    sum_vm_minus <span class="op">=</span> vm_minus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    sum_tr <span class="op">=</span> tr.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculates the Vortex Indicator components:</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VI+ = sum of VM+ over n periods divided by sum of TR over n periods</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VI− = sum of VM− over n periods divided by sum of TR over n periods</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    vi_plus <span class="op">=</span> sum_vm_plus <span class="op">/</span> sum_tr</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    vi_minus <span class="op">=</span> sum_vm_minus <span class="op">/</span> sum_tr</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns the VI+ and VI− series as output.</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vi_plus, vi_minus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-14" class="cell" data-outputid="d20f0c8a-1822-4449-8396-a9d5113f3deb" data-execution_count="1408">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for TSLA and stores the results as new columns in the DataFrame.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI+'</span>], tsla[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for XLY and stores the results as new columns in the DataFrame.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">'VI+'</span>], xly[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(xly, <span class="st">'XLY'</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for SPY and stores the results as new columns in the DataFrame.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">'VI+'</span>], spy[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(spy, <span class="st">'SPY'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-15" class="cell" data-execution_count="1409">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays the first 20 rows of the TSLA DataFrame to provide an initial overview of its structure and content with the new function applied.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>tsla.head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1409">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Close</th>
<th data-quarto-table-cell-role="th">High</th>
<th data-quarto-table-cell-role="th">Low</th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">VI+</th>
<th data-quarto-table-cell-role="th">VI-</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Ticker</th>
<th data-quarto-table-cell-role="th">TSLA</th>
<th data-quarto-table-cell-role="th">TSLA</th>
<th data-quarto-table-cell-role="th">TSLA</th>
<th data-quarto-table-cell-role="th">TSLA</th>
<th data-quarto-table-cell-role="th">TSLA</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-02</td>
<td>20.674667</td>
<td>21.008667</td>
<td>19.920000</td>
<td>20.406668</td>
<td>174879000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-03</td>
<td>20.024000</td>
<td>20.626667</td>
<td>19.825333</td>
<td>20.466667</td>
<td>104478000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-04</td>
<td>21.179333</td>
<td>21.200001</td>
<td>20.181999</td>
<td>20.400000</td>
<td>110911500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-07</td>
<td>22.330667</td>
<td>22.449333</td>
<td>21.183332</td>
<td>21.448000</td>
<td>113268000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-08</td>
<td>22.356667</td>
<td>22.934000</td>
<td>21.801332</td>
<td>22.797333</td>
<td>105127500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-09</td>
<td>22.568666</td>
<td>22.900000</td>
<td>22.098000</td>
<td>22.366667</td>
<td>81493500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-10</td>
<td>22.997999</td>
<td>23.025999</td>
<td>22.119333</td>
<td>22.293333</td>
<td>90846000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-11</td>
<td>23.150667</td>
<td>23.227333</td>
<td>22.584667</td>
<td>22.806000</td>
<td>75586500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-14</td>
<td>22.293333</td>
<td>22.833332</td>
<td>22.266666</td>
<td>22.825333</td>
<td>78709500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-15</td>
<td>22.962000</td>
<td>23.253332</td>
<td>22.299999</td>
<td>22.333332</td>
<td>90849000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-16</td>
<td>23.070000</td>
<td>23.466667</td>
<td>22.900000</td>
<td>22.985332</td>
<td>70375500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-17</td>
<td>23.153999</td>
<td>23.433332</td>
<td>22.943333</td>
<td>23.080667</td>
<td>55150500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-18</td>
<td>20.150667</td>
<td>21.808666</td>
<td>19.982000</td>
<td>21.533333</td>
<td>362262000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-22</td>
<td>19.927999</td>
<td>20.533333</td>
<td>19.700001</td>
<td>20.321333</td>
<td>181000500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-23</td>
<td>19.172667</td>
<td>19.633333</td>
<td>18.779333</td>
<td>19.500000</td>
<td>187950000</td>
<td>0.938520</td>
<td>0.946160</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-24</td>
<td>19.434000</td>
<td>19.578667</td>
<td>18.618668</td>
<td>18.868668</td>
<td>120183000</td>
<td>0.937771</td>
<td>0.927867</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-25</td>
<td>19.802668</td>
<td>19.901333</td>
<td>19.303333</td>
<td>19.625999</td>
<td>108744000</td>
<td>0.969095</td>
<td>0.953411</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-28</td>
<td>19.758667</td>
<td>19.830667</td>
<td>19.183332</td>
<td>19.527332</td>
<td>96349500</td>
<td>0.886399</td>
<td>1.047633</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-29</td>
<td>19.830667</td>
<td>19.903999</td>
<td>19.453333</td>
<td>19.684668</td>
<td>69325500</td>
<td>0.853825</td>
<td>1.081611</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-30</td>
<td>20.584667</td>
<td>20.600000</td>
<td>19.899332</td>
<td>20.030001</td>
<td>168754500</td>
<td>0.859650</td>
<td>1.020518</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="calculate-volume-weighted-sentiment" class="level3">
<h3 class="anchored" data-anchor-id="calculate-volume-weighted-sentiment">Calculate Volume-Weighted Sentiment</h3>
<div id="cell-17" class="cell" data-execution_count="1410">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the sentiment JSON file from local storage</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"TSLA_sentiment.json"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    sentiment_json <span class="op">=</span> json.load(f)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the "feed" list from the top-level JSON dictionary.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This section contains the array of sentiment articles or entries.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>sentiment_feed <span class="op">=</span> sentiment_json.get(<span class="st">"feed"</span>, [])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to hold cleaned and structured sentiment data</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> []</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through each item in the sentiment feed to extract relevant fields</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> sentiment_feed:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        sentiment_data.append({</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert the timestamp to pandas datetime for proper indexing</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"time_published"</span>: pd.to_datetime(item[<span class="st">"time_published"</span>]),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert the sentiment score string to float</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_score"</span>: <span class="bu">float</span>(item[<span class="st">"overall_sentiment_score"</span>]),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store the sentiment label (e.g., Positive, Neutral, Negative)</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_label"</span>: item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">KeyError</span>, <span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Skip malformed or incomplete entries that raise an error</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the structured list of dictionaries into a pandas DataFrame</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>sentiment_df <span class="op">=</span> pd.DataFrame(sentiment_data)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the 'time_published' column as the DataFrame index to enable time-series operations</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>sentiment_df.set_index(<span class="st">"time_published"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the DataFrame to verify content and structure</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentiment_df.head())</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Output a summary of the DataFrame structure, including column types and memory usage</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentiment_df.info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                     sentiment_score   sentiment_label
time_published                                        
2025-03-01 00:00:18         0.225994  Somewhat-Bullish
2025-02-28 20:33:00        -0.098739           Neutral
2025-02-28 20:07:43        -0.041235           Neutral
2025-02-28 20:07:36        -0.038786           Neutral
2025-02-28 18:24:25         0.021961           Neutral
&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 681 entries, 2025-03-01 00:00:18 to 2025-01-31 13:58:04
Data columns (total 2 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   sentiment_score  681 non-null    float64
 1   sentiment_label  681 non-null    object 
dtypes: float64(1), object(1)
memory usage: 16.0+ KB
None</code></pre>
</div>
</div>
<div id="cell-18" class="cell" data-execution_count="1411">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to store processed sentiment records</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> []</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through each news item in the 'feed' section of the JSON object</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> news_item <span class="kw">in</span> sentiment_json.get(<span class="st">"feed"</span>, []):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append a dictionary with selected and transformed fields to the sentiment list</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    sentiment_data.append({</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the time of publication to datetime format</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"time_published"</span>: pd.to_datetime(news_item[<span class="st">"time_published"</span>]),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the sentiment score (as-is; conversion to float may be handled separately if needed)</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sentiment_score"</span>: news_item[<span class="st">"overall_sentiment_score"</span>],</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the sentiment label (e.g., Positive, Neutral, Negative)</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sentiment_label"</span>: news_item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the list of dictionaries into a pandas DataFrame</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> pd.DataFrame(sentiment_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-19" class="cell" data-execution_count="1412">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the DataFrame by publication time in ascending order for chronological analysis</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sentiment_data[<span class="st">'time_published'</span>].sort_values(ascending<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1412">
<pre><code>680   2025-01-31 13:58:04
679   2025-01-31 14:05:00
678   2025-01-31 14:05:31
677   2025-01-31 14:31:00
676   2025-01-31 15:13:26
              ...        
4     2025-02-28 18:24:25
3     2025-02-28 20:07:36
2     2025-02-28 20:07:43
1     2025-02-28 20:33:00
0     2025-03-01 00:00:18
Name: time_published, Length: 681, dtype: datetime64[ns]</code></pre>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="1413">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the 'time_published' column to only retain the date portion (drop time-of-day)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sentiment_data[<span class="st">'time_published'</span>] <span class="op">=</span> sentiment_data[<span class="st">'time_published'</span>].dt.date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-21" class="cell" data-execution_count="1414">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter sentiment data to retain only those records that match dates present in the TSLA index</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_data[</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    pd.to_datetime(sentiment_data[<span class="st">'time_published'</span>]).isin(tsla.index)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the filtered data by publication date and calculate the average sentiment score per day</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_scores_filtered.groupby(<span class="st">'time_published'</span>)[<span class="st">'sentiment_score'</span>].mean().reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-22" class="cell" data-execution_count="1415">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix the multi-level column issue by selecting the 'Volume' column and resetting its name</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>tsla_volume <span class="op">=</span> tsla[(<span class="st">'Volume'</span>, <span class="st">'TSLA'</span>)].rename(<span class="st">'Volume'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the index of tsla_volume is a column and convert it to match the type of time_published</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>tsla_volume <span class="op">=</span> tsla_volume.reset_index()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>tsla_volume[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(tsla_volume[<span class="st">'Date'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-23" class="cell" data-execution_count="1416">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert 'time_published' in the sentiment data to datetime to match volume data type</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered[<span class="st">'time_published'</span>] <span class="op">=</span> pd.to_datetime(sentiment_scores_filtered[<span class="st">'time_published'</span>])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform an inner merge between sentiment scores and volume data based on matching dates</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    tsla_volume,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    sentiment_scores_filtered,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'time_published'</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-24" class="cell" data-execution_count="1417">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted sentiment by multiplying raw sentiment by trading volume</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Weighted_Sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Volume'</span>] <span class="op">*</span> merged_data[<span class="st">'sentiment_score'</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate a 5-day rolling average of the weighted sentiment to smooth short-term noise</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Weighted_Sentiment'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a binary condition for when the average sentiment is positive</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Condition'</span>] <span class="op">=</span> merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the rolling sentiment score by average volume to allow comparability across scales</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>] <span class="op">=</span> (</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">/</span> merged_data[<span class="st">'Volume'</span>].mean()</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-25" class="cell" data-execution_count="1418">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>merged_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1418">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">Weighted_Sentiment</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment</th>
<th data-quarto-table-cell-role="th">Buy_Condition</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment_norm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-01-31</td>
<td>83568200</td>
<td>2025-01-31</td>
<td>0.194614</td>
<td>1.626354e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-02-03</td>
<td>93732100</td>
<td>2025-02-03</td>
<td>0.129243</td>
<td>1.211426e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-02-04</td>
<td>57072200</td>
<td>2025-02-04</td>
<td>0.173107</td>
<td>9.879602e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-02-05</td>
<td>57223300</td>
<td>2025-02-05</td>
<td>0.136874</td>
<td>7.832396e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-02-06</td>
<td>77918200</td>
<td>2025-02-06</td>
<td>0.118095</td>
<td>9.201782e+06</td>
<td>1.105832e+07</td>
<td>True</td>
<td>0.132787</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2025-02-07</td>
<td>70298300</td>
<td>2025-02-07</td>
<td>0.133871</td>
<td>9.410915e+06</td>
<td>9.687792e+06</td>
<td>True</td>
<td>0.116330</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2025-02-10</td>
<td>77514900</td>
<td>2025-02-10</td>
<td>0.152754</td>
<td>1.184073e+07</td>
<td>9.633086e+06</td>
<td>True</td>
<td>0.115673</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2025-02-11</td>
<td>118543400</td>
<td>2025-02-11</td>
<td>0.164455</td>
<td>1.949505e+07</td>
<td>1.155618e+07</td>
<td>True</td>
<td>0.138766</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2025-02-12</td>
<td>105382700</td>
<td>2025-02-12</td>
<td>0.147806</td>
<td>1.557620e+07</td>
<td>1.310494e+07</td>
<td>True</td>
<td>0.157363</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2025-02-13</td>
<td>89441500</td>
<td>2025-02-13</td>
<td>0.157124</td>
<td>1.405337e+07</td>
<td>1.407525e+07</td>
<td>True</td>
<td>0.169015</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2025-02-14</td>
<td>68277300</td>
<td>2025-02-14</td>
<td>0.148619</td>
<td>1.014733e+07</td>
<td>1.422254e+07</td>
<td>True</td>
<td>0.170783</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2025-02-18</td>
<td>51631700</td>
<td>2025-02-18</td>
<td>0.147289</td>
<td>7.604774e+06</td>
<td>1.337534e+07</td>
<td>True</td>
<td>0.160610</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2025-02-19</td>
<td>67094400</td>
<td>2025-02-19</td>
<td>0.142078</td>
<td>9.532654e+06</td>
<td>1.138286e+07</td>
<td>True</td>
<td>0.136685</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2025-02-20</td>
<td>45965400</td>
<td>2025-02-20</td>
<td>0.168076</td>
<td>7.725658e+06</td>
<td>9.812757e+06</td>
<td>True</td>
<td>0.117831</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2025-02-21</td>
<td>74058600</td>
<td>2025-02-21</td>
<td>0.159107</td>
<td>1.178322e+07</td>
<td>9.358728e+06</td>
<td>True</td>
<td>0.112379</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>2025-02-24</td>
<td>76052300</td>
<td>2025-02-24</td>
<td>0.110839</td>
<td>8.429546e+06</td>
<td>9.015171e+06</td>
<td>True</td>
<td>0.108253</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>2025-02-25</td>
<td>134228800</td>
<td>2025-02-25</td>
<td>0.071949</td>
<td>9.657658e+06</td>
<td>9.425748e+06</td>
<td>True</td>
<td>0.113184</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>2025-02-26</td>
<td>100118300</td>
<td>2025-02-26</td>
<td>0.142984</td>
<td>1.431534e+07</td>
<td>1.038228e+07</td>
<td>True</td>
<td>0.124670</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>2025-02-27</td>
<td>101748200</td>
<td>2025-02-27</td>
<td>0.174702</td>
<td>1.777563e+07</td>
<td>1.239228e+07</td>
<td>True</td>
<td>0.148806</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>2025-02-28</td>
<td>115697000</td>
<td>2025-02-28</td>
<td>0.115746</td>
<td>1.339148e+07</td>
<td>1.271393e+07</td>
<td>True</td>
<td>0.152668</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="derive-atr-10-for-volatility-adjustments" class="level3">
<h3 class="anchored" data-anchor-id="derive-atr-10-for-volatility-adjustments">Derive ATR (10) for Volatility Adjustments</h3>
<div id="cell-27" class="cell" data-execution_count="1419">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten MultiIndex columns if present to simplify DataFrame operations</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>tsla.columns <span class="op">=</span> [</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> tsla.columns</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the previous closing price to support True Range computation</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"prev_close"</span>] <span class="op">=</span> tsla[<span class="st">"Close_TSLA"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute three True Range variations used in ATR calculation</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr1"</span>] <span class="op">=</span> tsla[<span class="st">"High_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"Low_TSLA"</span>]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(tsla[<span class="st">"High_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"prev_close"</span>])</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(tsla[<span class="st">"Low_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"prev_close"</span>])</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Derive the True Range (TR) as the maximum of the three variants</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"true_range"</span>] <span class="op">=</span> tsla[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the 10-day Average True Range (ATR) to measure market volatility</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"ATR_10"</span>] <span class="op">=</span> tsla[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR as a percentage of the current closing price to normalize volatility</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"atr_pct"</span>] <span class="op">=</span> tsla[<span class="st">"ATR_10"</span>] <span class="op">/</span> tsla[<span class="st">"Close_TSLA"</span>]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to assign position size based on volatility levels</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># Allocate 1% of capital for low-volatility conditions</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># Allocate 0.5% of capital for high-volatility conditions</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the position size function across all rows</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"position_size"</span>] <span class="op">=</span> tsla.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the latest 10 rows with selected indicators for inspection</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla[[<span class="st">"Close_TSLA"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_TSLA     ATR_10   atr_pct  position_size
Date                                                      
2025-02-19  360.559998  16.703000  0.046325          0.005
2025-02-20  354.399994  16.464999  0.046459          0.005
2025-02-21  337.799988  17.021997  0.050391          0.005
2025-02-24  330.529999  16.770996  0.050740          0.005
2025-02-25  302.799988  18.879996  0.062351          0.005
2025-02-26  290.799988  18.412994  0.063318          0.005
2025-02-27  281.950012  18.257996  0.064756          0.005
2025-02-28  292.980011  18.067996  0.061670          0.005
2025-03-03  284.649994  19.281998  0.067739          0.005
2025-03-04  272.040009  20.654996  0.075926          0.005</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="1420">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a line chart to visualize the ATR% (Average True Range as a percentage of price) over time</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    tsla, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"atr_pct"</span>, </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ATR% Over Time"</span>  <span class="co"># Title of the chart</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a horizontal reference line at 3% to represent the low-volatility cutoff threshold</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>fig.add_hline(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.03</span>, </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    line_dash<span class="op">=</span><span class="st">"dot"</span>, </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    line_color<span class="op">=</span><span class="st">"green"</span>, </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the chart</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>The chart illustrates the historical volatility of TSLA, measured by the Average True Range (ATR) as a percentage of the closing price. Periods where the ATR% falls below the dotted green line at 3% indicate low volatility, which is typically associated with more stable market conditions. In contrast, noticeable spikes—such as those seen in 2020 and 2021—reflect periods of heightened volatility. More recently, ATR% values appear to remain closer to or slightly above the low-volatility threshold, suggesting relatively calmer market behavior compared to earlier years.</p>
<div id="cell-30" class="cell" data-execution_count="1421">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the TSLA DataFrame to include only records from the year 2025</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tsla_2025 <span class="op">=</span> tsla[tsla.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a line chart to visualize ATR% for TSLA during 2025</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    tsla_2025,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"atr_pct"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ATR% Over Time (2025 Only)"</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a horizontal line at the 3% threshold to denote the low-volatility cutoff</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>fig.add_hline(</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.03</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    line_dash<span class="op">=</span><span class="st">"dot"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    line_color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the chart</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>The chart displays ATR% for TSLA during 2025, reflecting how the stock’s volatility has evolved since the start of the year. While ATR% began above the 7% mark in early January, it gradually declined and remained mostly between 4% and 6% throughout February. Although volatility did not breach the low-volatility threshold of 3%, the dip toward that level suggests a period of relative calm. Toward early March, ATR% showed a clear upward trend, indicating a potential resurgence in market volatility.</p>
<div id="cell-32" class="cell" data-execution_count="1422">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Buy Signal</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> tsla[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI-_'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Sell Signal (basic)</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> tsla[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI+_'</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the position tracking column with 0 (no active position)</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a variable to store the peak price during a position for trailing stop logic</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the dataset starting from index 1 to access previous values</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(tsla)):</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entry condition: enter a position if a buy signal is present</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tsla[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        tsla.at[tsla.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Mark entry into a position</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> tsla[<span class="st">'Close_TSLA'</span>].iloc[i]  <span class="co"># Record the entry price as initial peak</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If already in position, check for exit condition using trailing stop</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> tsla[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> tsla[<span class="st">'Close_TSLA'</span>].iloc[i]  <span class="co"># Current closing price</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)  <span class="co"># Update peak price if current exceeds previous</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price  <span class="co"># Compute drawdown from peak</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exit condition: drawdown exceeds 3%</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>            tsla.at[tsla.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># Trigger a sell signal</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>            tsla.at[tsla.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span>        <span class="co"># Exit position</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>            tsla.at[tsla.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>        <span class="co"># Maintain position</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the total number of buy and sell signals generated across the dataset</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, tsla[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, tsla[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 857
Sell signals: 680</code></pre>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="1423">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty figure object</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the TSLA closing price as a continuous line</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'TSLA Price'</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers to indicate Buy Signals using upward-pointing green triangles</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Buy_Signal'</span>]].index,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Buy_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers to indicate Sell Signals using downward-pointing red triangles</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout settings including title and visual style</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'TSLA Buy &amp; Sell Signals'</span>,</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the interactive plot</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>The chart illustrates the closing price of Tesla stock over time, with overlaid trading signals generated by the strategy. Green upward triangles represent buy signals, while red downward triangles mark sell signals. These signals are distributed throughout periods of both rising and falling prices, reflecting how the algorithm dynamically enters and exits positions based on market conditions. Clusters of signals during high-volatility periods—such as 2020, 2021, and early 2025—indicate frequent entries and exits, whereas more stable phases show fewer trades.</p>
<div id="cell-35" class="cell" data-execution_count="1424">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR as a percentage of the closing price to normalize volatility</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'atr_pct'</span>] <span class="op">=</span> tsla[<span class="st">'ATR_10'</span>] <span class="op">/</span> tsla[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Vortex Indicator crossover signals:</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Up: Identifies when VI+ crosses above VI− (potential bullish signal)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Down: Identifies when VI− crosses above VI+ (potential bearish signal)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (tsla[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI-_'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (tsla[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI+_'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal and state columns</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span>          <span class="co"># Flag for buy signal</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span>         <span class="co"># Flag for sell signal</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span>                <span class="co"># Position state: 1 = in position, 0 = no position</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>           <span class="co"># Strategy classification: 'aggressive' or 'conservative'</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize control variables for trailing stop and price tracking</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span>                 <span class="co"># Boolean flag for current position state</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span>                      <span class="co"># Highest price observed during an open position</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the DataFrame to simulate trading logic based on Vortex signals and volatility</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(tsla)):</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> tsla.iloc[i]</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> tsla.index[i]</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition: Enter a new position if VI_Cross_Up occurs and no current position is held</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">and</span> row[<span class="st">'VI_Cross_Up'</span>]:</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        tsla.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classify entry type based on volatility threshold</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, evaluate for trailing stop or VI_Cross_Down exit condition</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sell condition: Exit if drawdown exceeds 3% or VI_Cross_Down occurs</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Maintain position</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the total count of each type of signal and entry classification</span></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, tsla[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, tsla[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 80
Sell signals: 80
Aggressive entries: 5
Conservative entries: 75</code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-execution_count="1425">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty figure to hold all plot layers</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the TSLA closing price as a continuous blue line</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'TSLA Price'</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for aggressive buy signals (Entry_Type = 'aggressive')</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)].index,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Aggressive)'</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'limegreen'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for conservative buy signals (Entry_Type = 'conservative')</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)].index,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Conservative)'</span>,</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for sell signals using red downward-pointing triangles</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span>,</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, color<span class="op">=</span><span class="st">'red'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure chart layout with appropriate title, axis labels, and style</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'TSLA Buy/Sell Signals Over Time'</span>,</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Price (USD)'</span>,</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span>,</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">600</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the figure</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>The chart displays the historical closing price of Tesla (TSLA) stock alongside algorithmically generated buy and sell signals. The blue line represents TSLA’s closing price, while the green upward-pointing triangles indicate buy entries—distinguished by lime green for aggressive entries (lower volatility) and dark green for conservative entries (higher volatility). Red downward-pointing triangles represent sell signals.</p>
<p>The buy signals are generally aligned with upward momentum, and sell signals frequently follow periods of short-term retracement or heightened volatility. The system shows particularly dense activity around highly volatile phases, such as mid-2020 to early 2022, capturing many entries and exits. In contrast, during more stable periods, the signals are more spaced out. Overall, the plot provides a clear visual assessment of how the strategy adapts dynamically to changing market conditions by modulating its entries based on volatility and exiting with protective trailing logic.</p>
</section>
</section>
<section id="tesla-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="tesla-analysis-results">Tesla Analysis Results</h2>
<div id="cell-39" class="cell" data-execution_count="1426">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>tsla_signals <span class="op">=</span> tsla.reset_index()[[<span class="st">'Date'</span>, <span class="st">'VI_Cross_Up'</span>, <span class="st">'VI_Cross_Down'</span>, <span class="st">'atr_pct'</span>, <span class="st">'Close_TSLA'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-40" class="cell" data-execution_count="1427">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(merged_data, tsla, on<span class="op">=</span><span class="st">'Date'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-41" class="cell" data-execution_count="1428">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'atr_pct'</span>] <span class="op">=</span> merged_data[<span class="st">'ATR_10'</span>] <span class="op">/</span> merged_data[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vortex crossover logic</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI-_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI+_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal &amp; state columns</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>  <span class="co"># aggressive/conservative</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trailing stop logic variables</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(merged_data)):</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> merged_data.index[i]</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">or</span> row[<span class="st">'VI_Cross_Up'</span>] <span class="kw">or</span> row[<span class="st">'5_day_avg_sentiment_norm'</span>]<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entry Type: aggressive if ATR &lt; 3%, else conservative</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, check for trailing stop or VI cross down</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Show result counts</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, merged_data[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, merged_data[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 18
Sell signals: 1
Aggressive entries: 0
Conservative entries: 18</code></pre>
</div>
</div>
<div id="cell-42" class="cell" data-execution_count="1429">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'Date' is datetime and set as index if needed</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(merged_data[<span class="st">'Date'</span>])</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5-day Avg Sentiment</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ATR %</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'atr_pct'</span>],</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'ATR %'</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="st">'y2'</span>,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Highlight Buy Signal Dates (even though there are none now)</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'Date'</span>],</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>, symbol<span class="op">=</span><span class="st">'star'</span>),</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dual axis layout</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"5-Day Sentiment vs ATR % (with Buy Signals)"</span>,</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>),</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    yaxis2<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'ATR %'</span>, overlaying<span class="op">=</span><span class="st">'y'</span>, side<span class="op">=</span><span class="st">'right'</span>),</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="fl">0.01</span>, y<span class="op">=</span><span class="fl">0.99</span>),</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="1430">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize portfolio variables</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span>                   <span class="co"># Starting capital for the simulation</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span>               <span class="co"># Flag indicating whether a position is currently held</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span>                   <span class="co"># Entry price of the current position</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span>                <span class="co"># Dollar value allocated to the position</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital                    <span class="co"># Available cash (initially equal to capital)</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []                      <span class="co"># List to store profit/loss for each trade</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate over the dataset to simulate trading</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(merged_data)):</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==== Buy Logic ====</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]             <span class="co"># Fraction of capital to allocate</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size            <span class="co"># Calculate how much capital to invest</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]                  <span class="co"># Record entry price</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price     <span class="co"># Calculate number of shares to buy</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value                           <span class="co"># Deduct invested capital from cash</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span>                               <span class="co"># Update position flag</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==== Sell Logic ====</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]                   <span class="co"># Get the exit price</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price            <span class="co"># Calculate proceeds from sale</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value               <span class="co"># Profit = proceeds - initial investment</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds                                 <span class="co"># Add proceeds back to cash</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)                           <span class="co"># Record trade return</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span>                              <span class="co"># Reset position state</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span>                               <span class="co"># Clear position value</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span>                                  <span class="co"># Reset entry price</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ==== Final Capital Calculation ====</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="co"># If still holding a position, add unrealized value to cash</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_TSLA'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital                    <span class="co"># Net profit/loss from strategy</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ==== Print Performance Metrics ====</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:,.2f}</span><span class="ss">"</span>)</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $99,898.47
Total Return: $-101.53
Total Trades: 1
Average Profit per Trade: $11.12</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="1431">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure index is datetime and 'Close_TSLA' exists</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> tsla[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate entries and exits from your signals</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> tsla[<span class="st">'Buy_Signal'</span>]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> tsla[<span class="st">'Sell_Signal'</span>]</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create portfolio</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>np.nan,  <span class="co"># Let it auto-calculate position size if fixed capital</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span>,  <span class="co"># 0.1% per trade</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    slippage<span class="op">=</span><span class="fl">0.0005</span>  <span class="co"># Optional</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-45" class="cell" data-execution_count="1432">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary stats</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Equity curve</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                                100000.0
Total Return [%]                              0.0
Benchmark Return [%]                  1215.813231
Max Gross Exposure [%]                        0.0
Total Fees Paid                               0.0
Max Drawdown [%]                              NaN
Max Drawdown Duration                         NaN
Total Trades                                    0
Total Closed Trades                             0
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                                  NaN
Best Trade [%]                                NaN
Worst Trade [%]                               NaN
Avg Winning Trade [%]                         NaN
Avg Losing Trade [%]                          NaN
Avg Winning Trade Duration                    NaN
Avg Losing Trade Duration                     NaN
Profit Factor                                 NaN
Expectancy                                    NaN
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="1433">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())  <span class="co"># Should be &gt; 0</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())  <span class="co"># Should also be &gt; 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>80
80</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="1434">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> tsla.dropna(subset<span class="op">=</span>[<span class="st">'Close_TSLA'</span>])</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> tsla[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> tsla[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-48" class="cell" data-execution_count="1435">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> tsla[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           162759.235978
Total Return [%]                        62.759236
Benchmark Return [%]                  1215.813231
Max Gross Exposure [%]                      100.0
Total Fees Paid                      24054.581607
Max Drawdown [%]                        55.348959
Max Drawdown Duration                       730.0
Total Trades                                   80
Total Closed Trades                            80
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                                 32.5
Best Trade [%]                          46.283397
Worst Trade [%]                         -9.410141
Avg Winning Trade [%]                   11.344578
Avg Losing Trade [%]                    -3.847352
Avg Winning Trade Duration               7.076923
Avg Losing Trade Duration                2.537037
Profit Factor                            1.194803
Expectancy                              784.49045
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>The backtest results show that while the strategy achieved a total return of approximately 62.76%, it significantly underperformed compared to a simple buy-and-hold strategy on TSLA, which yielded a 1215.81% return. The strategy executed 80 trades with a low win rate of 32.5%, indicating that most trades were unprofitable. Although it had a few strong winners, the average profit per trade was marginal, with a profit factor of 1.19. Additionally, the portfolio experienced a substantial maximum drawdown of 55.35% and a prolonged recovery period lasting two years, signaling high risk. Visuals further confirm that many trades resulted in small losses or gains, with only a few notable profitable exits. Overall, while the strategy demonstrates some profitability, its risk-return profile is weak and may require optimization in entry/exit logic, volatility filtering, or sentiment integration to compete with the benchmark performance.</p>
</section>
<section id="xly-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="xly-analysis-results">XLY Analysis Results</h2>
<div id="cell-51" class="cell" data-execution_count="1436">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://www.alphavantage.co/query?function=NEWS_SENTIMENT&amp;date_from=20250101T0130&amp;date_to=20250301T0130&amp;limit=1000&amp;tickers=XLY&amp;apikey=PNM5EHRALIOT1CKJ'</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    sentiment_data <span class="op">=</span> response.json()</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    sentiment_df <span class="op">=</span> pd.DataFrame(sentiment_data[<span class="st">'feed'</span>]) </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(sentiment_df.head())</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"API call failed:"</span>, response.status_code)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>sentiment_json <span class="op">=</span> response.json()</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentiment_json)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[1436], line 7</span>
<span class="ansi-green-fg ansi-bold">      5</span> if response.status_code == 200:
<span class="ansi-green-fg ansi-bold">      6</span>     sentiment_data = response.json()
<span class="ansi-green-fg">----&gt; 7</span>     sentiment_df = pd.DataFrame(sentiment_data['feed']) 
<span class="ansi-green-fg ansi-bold">      8</span>     print(sentiment_df.head())
<span class="ansi-green-fg ansi-bold">      9</span> else:

<span class="ansi-red-fg">KeyError</span>: 'feed'</pre>
</div>
</div>
</div>
<div id="cell-52" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> []</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> news_item <span class="kw">in</span> sentiment_json.get(<span class="st">"feed"</span>, []):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    sentiment_data.append({</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"time_published"</span>: pd.to_datetime(news_item[<span class="st">"time_published"</span>]),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_score"</span>: news_item[<span class="st">"overall_sentiment_score"</span>],</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_label"</span>: news_item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> pd.DataFrame(sentiment_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>

<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)

Cell <span class="ansi-green-fg">In[6], line 2</span>

<span class="ansi-green-fg ansi-bold">      1</span> sentiment_data = []

<span class="ansi-green-fg">----&gt; 2</span> for news_item in sentiment_json.get("feed", []):

<span class="ansi-green-fg ansi-bold">      3</span>     sentiment_data.append({

<span class="ansi-green-fg ansi-bold">      4</span>             "time_published": pd.to_datetime(news_item["time_published"]),

<span class="ansi-green-fg ansi-bold">      5</span>             "sentiment_score": news_item["overall_sentiment_score"],

<span class="ansi-green-fg ansi-bold">      6</span>             "sentiment_label": news_item["overall_sentiment_label"],

<span class="ansi-green-fg ansi-bold">      7</span>     })

<span class="ansi-green-fg ansi-bold">      8</span> sentiment_data = pd.DataFrame(sentiment_data)



<span class="ansi-red-fg">NameError</span>: name 'sentiment_json' is not defined</pre>
</div>
</div>
</div>
<div id="cell-53" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>sentiment_data[<span class="st">'time_published'</span>] <span class="op">=</span> sentiment_data[<span class="st">'time_published'</span>].dt.date</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_data[pd.to_datetime(sentiment_data[<span class="st">'time_published'</span>]).isin(tsla.index)]</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_scores_filtered.groupby(<span class="st">'time_published'</span>)[<span class="st">'sentiment_score'</span>].mean().reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-54" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix the multi-level column issue by selecting the 'Volume' column and resetting its name</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>xly_volume <span class="op">=</span> xly[(<span class="st">'Volume'</span>, <span class="st">'XLY'</span>)].rename(<span class="st">'Volume'</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the index of tsla_volume is a column and convert it to match the type of time_published</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>xly_volume <span class="op">=</span> xly_volume.reset_index()</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>xly_volume[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(xly_volume[<span class="st">'Date'</span>])</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert time_published to datetime</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered[<span class="st">'time_published'</span>] <span class="op">=</span> pd.to_datetime(sentiment_scores_filtered[<span class="st">'time_published'</span>])</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the dataframes</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(xly_volume, sentiment_scores_filtered, left_on<span class="op">=</span><span class="st">'Date'</span>, right_on<span class="op">=</span><span class="st">'time_published'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Weighted_Sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Volume'</span>] <span class="op">*</span> merged_data[<span class="st">'sentiment_score'</span>]</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Weighted_Sentiment'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Condition'</span>] <span class="op">=</span> merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>] <span class="op">=</span> merged_data[<span class="st">'5_day_avg_sentiment'</span>]<span class="op">/</span>merged_data[<span class="st">'Volume'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-55" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten MultiIndex columns </span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>xly.columns <span class="op">=</span> [</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> xly.columns</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate True Range</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"prev_close"</span>] <span class="op">=</span> xly[<span class="st">"Close_XLY"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"tr1"</span>] <span class="op">=</span> xly[<span class="st">"High_XLY"</span>] <span class="op">-</span> xly[<span class="st">"Low_XLY"</span>]</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(xly[<span class="st">"High_XLY"</span>] <span class="op">-</span> xly[<span class="st">"prev_close"</span>])</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(xly[<span class="st">"Low_XLY"</span>] <span class="op">-</span> xly[<span class="st">"prev_close"</span>])</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"true_range"</span>] <span class="op">=</span> xly[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 10-day ATR</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"ATR_10"</span>] <span class="op">=</span> xly[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 4: Calculate ATR as a percentage of closing price ----</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"atr_pct"</span>] <span class="op">=</span> xly[<span class="st">"ATR_10"</span>] <span class="op">/</span> xly[<span class="st">"Close_XLY"</span>]</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="co"># allocating the capital</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:  <span class="co"># &lt; 3% volatility → low risk</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># allocate 1% of capital</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># ≥ 3% volatility → high risk</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># allocate 0.5% of capital</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"position_size"</span>] <span class="op">=</span> xly.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 6: Optional - Capital allocation per trade ----</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="co">#capital = 100000 # Example: $100K total portfolio</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="co">#xly["allocation_dollars"] = xly["position_size"] * capital</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(xly[[<span class="st">"Close_XLY"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Close_XLY    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  225.618988  2.870099  0.012721           0.01
2025-02-20  223.674316  2.919964  0.013055           0.01
2025-02-21  217.790527  3.453495  0.015857           0.01
2025-02-24  216.972778  3.270997  0.015076           0.01
2025-02-25  215.835892  3.511334  0.016269           0.01
2025-02-26  214.948349  3.602083  0.016758           0.01
2025-02-27  211.846878  3.751672  0.017709           0.01
2025-02-28  215.367203  3.836439  0.017813           0.01
2025-03-03  211.398117  4.429805  0.020955           0.01
2025-03-04  207.668396  4.845659  0.023334           0.01</code></pre>
</div>
</div>
<div id="cell-56" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(xly, x<span class="op">=</span>xly.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time"</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-57" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only 2025 data</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>xly_2025 <span class="op">=</span> xly[xly.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(xly_2025, x<span class="op">=</span>xly_2025.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time (2025 Only)"</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-58" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(merged_data, xly, on<span class="op">=</span><span class="st">'Date'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-59" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'atr_pct'</span>] <span class="op">=</span> merged_data[<span class="st">'ATR_10'</span>] <span class="op">/</span> merged_data[<span class="st">'Close_XLY'</span>]</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vortex crossover logic</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI-_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI+_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal &amp; state columns</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>  <span class="co"># aggressive/conservative</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trailing stop logic variables</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(merged_data)):</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> merged_data.index[i]</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">or</span> row[<span class="st">'VI_Cross_Up'</span>] <span class="kw">or</span> row[<span class="st">'5_day_avg_sentiment_norm'</span>]<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entry Type: aggressive if ATR &lt; 3%, else conservative</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, check for trailing stop or VI cross down</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Show result counts</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, merged_data[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, merged_data[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 17
Sell signals: 1
Aggressive entries: 17
Conservative entries: 0</code></pre>
</div>
</div>
<div id="cell-60" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot merged_data closing price</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data.index, </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'Close_XLY'</span>], </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>, </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'merged_data Price'</span>, </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggressive buys</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)].index,</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)][<span class="st">'Close_XLY'</span>],</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Aggressive)'</span>,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'limegreen'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative buys</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)].index,</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)][<span class="st">'Close_XLY'</span>],</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Conservative)'</span>,</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Sells</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_XLY'</span>],</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span>,</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, color<span class="op">=</span><span class="st">'red'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'merged_data Buy/Sell Signals Over Time'</span>,</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Price (USD)'</span>,</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span>,</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">600</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-61" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'Date' is datetime and set as index if needed</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(merged_data[<span class="st">'Date'</span>])</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5-day Avg Sentiment</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>,</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ATR %</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'atr_pct'</span>],</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'ATR %'</span>,</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="st">'y2'</span>,</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Highlight Buy Signal Dates (even though there are none now)</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'Date'</span>],</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>, symbol<span class="op">=</span><span class="st">'star'</span>),</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dual axis layout</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"5-Day Sentiment vs ATR % (with Buy Signals)"</span>,</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>),</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>    yaxis2<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'ATR %'</span>, overlaying<span class="op">=</span><span class="st">'y'</span>, side<span class="op">=</span><span class="st">'right'</span>),</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="fl">0.01</span>, y<span class="op">=</span><span class="fl">0.99</span>),</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-62" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>merged_data.index, y<span class="op">=</span>merged_data[<span class="st">'Close_XLY'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'merged_data Price'</span>))</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Buy markers</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Buy_Signal'</span>]].index,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Buy_Signal'</span>]][<span class="st">'Close_XLY'</span>],</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Sell markers</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_XLY'</span>],</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>fig.update_layout(title<span class="op">=</span><span class="st">'XLY Buy &amp; Sell Signals'</span>, template<span class="op">=</span><span class="st">'plotly_white'</span>)</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-63" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(merged_data)):</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Final capital</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_XLY'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $99904.34
Total Return: $-95.66
Total Trades: 1
Average Profit per Trade: $-15.67</code></pre>
</div>
</div>
<section id="without-sentiment-code" class="level3">
<h3 class="anchored" data-anchor-id="without-sentiment-code">Without sentiment code</h3>
<div id="cell-65" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Without sentiment score</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>xly_copy <span class="op">=</span> xly.copy()</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>xly_copy[<span class="st">'atr_pct'</span>] <span class="op">=</span> xly_copy[<span class="st">'ATR_10'</span>] <span class="op">/</span> xly_copy[<span class="st">'Close_XLY'</span>]</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Buy Signal (assuming VI_Cross_Up is defined elsewhere)</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>xly_copy[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> xly_copy[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> xly_copy[<span class="st">'VI-_'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># + add any other buy conditions here...</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Sell Signal (basic)</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>xly_copy[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> xly_copy[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> xly_copy[<span class="st">'VI+_'</span>]</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize position state</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>xly_copy[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(xly_copy)):</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> xly_copy[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        xly_copy.at[xly_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> xly_copy[<span class="st">'Close_XLY'</span>].iloc[i]</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> xly_copy[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> xly_copy[<span class="st">'Close_XLY'</span>].iloc[i]</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>            xly_copy.at[xly_copy.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># trailing stop</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>            xly_copy.at[xly_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>            xly_copy.at[xly_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-66" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(xly_copy)):</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> xly_copy.iloc[i]</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_XLY'</span>]</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Final capital</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_XLY'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100732.95
Total Return: $732.95
Total Trades: 75
Average Profit per Trade: $9.77</code></pre>
</div>
</div>
<div id="cell-67" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> xly_copy.dropna(subset<span class="op">=</span>[<span class="st">'Close_XLY'</span>])</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> xly_copy[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> xly_copy[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> xly_copy[<span class="st">'Close_XLY'</span>]</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>

<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)

<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[23]</span><span class="ansi-green-fg">, line 1</span>

<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">vectorbt</span><span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(0,135,0)">as</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">vbt</span>

<span class="ansi-green-fg">      3</span> xly = xly_copy.dropna(subset=[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">Close_XLY</span><span class="ansi-yellow-fg">'</span>])

<span class="ansi-green-fg">      4</span> entries = xly_copy[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">Buy_Signal</span><span class="ansi-yellow-fg">'</span>].astype(<span style="color:rgb(0,135,0)">bool</span>)



<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named 'vectorbt'</pre>
</div>
</div>
</div>
<div id="cell-68" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure index is datetime and 'Close_TSLA' exists</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> merged_data[<span class="st">'Close_XLY'</span>]</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate entries and exits from your signals</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> merged_data[<span class="st">'Buy_Signal'</span>]</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> merged_data[<span class="st">'Sell_Signal'</span>]</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create portfolio</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>np.nan,  <span class="co"># Let it auto-calculate position size if fixed capital</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span>,  <span class="co"># 0.1% per trade</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    slippage<span class="op">=</span><span class="fl">0.0005</span>  <span class="co"># Optional</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot portfolio value</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-69" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary stats</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Equity curve</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                              0.000000
End                               19.000000
Period                            20.000000
Start Value                   100000.000000
End Value                     100000.000000
Total Return [%]                   0.000000
Benchmark Return [%]             -10.163929
Max Gross Exposure [%]             0.000000
Total Fees Paid                    0.000000
Max Drawdown [%]                        NaN
Max Drawdown Duration                   NaN
Total Trades                       0.000000
Total Closed Trades                0.000000
Total Open Trades                  0.000000
Open Trade PnL                     0.000000
Win Rate [%]                            NaN
Best Trade [%]                          NaN
Worst Trade [%]                         NaN
Avg Winning Trade [%]                   NaN
Avg Losing Trade [%]                    NaN
Avg Winning Trade Duration              NaN
Avg Losing Trade Duration               NaN
Profit Factor                           NaN
Expectancy                              NaN
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-70" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> merged_data.dropna(subset<span class="op">=</span>[<span class="st">'Close_XLY'</span>])</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> merged_data[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> merged_data[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-71" class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> merged_data[<span class="st">'Close_XLY'</span>]</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/begiii/Documents/SPRING 2025/Hackathon_Spring_2025/Vortex-Sentiment-Adaptive-Volatility-VSAV-Strategy/.venv/lib/python3.9/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                              0.000000
End                               19.000000
Period                            20.000000
Start Value                   100000.000000
End Value                      90286.704981
Total Return [%]                  -9.713295
Benchmark Return [%]             -10.163929
Max Gross Exposure [%]           100.000000
Total Fees Paid                  296.373903
Max Drawdown [%]                   9.980462
Max Drawdown Duration             17.000000
Total Trades                       2.000000
Total Closed Trades                1.000000
Total Open Trades                  1.000000
Open Trade PnL                 -7950.098224
Win Rate [%]                       0.000000
Best Trade [%]                    -1.764960
Worst Trade [%]                   -1.764960
Avg Winning Trade [%]                   NaN
Avg Losing Trade [%]              -1.764960
Avg Winning Trade Duration              NaN
Avg Losing Trade Duration          2.000000
Profit Factor                      0.000000
Expectancy                     -1763.196795
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
</section>
</section>
<section id="spy-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="spy-analysis-results">SPY Analysis Results</h2>
<div id="cell-73" class="cell" data-execution_count="1437">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten MultiIndex columns </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>spy.columns <span class="op">=</span> [</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> spy.columns</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate True Range</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"prev_close"</span>] <span class="op">=</span> spy[<span class="st">"Close_SPY"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"tr1"</span>] <span class="op">=</span> spy[<span class="st">"High_SPY"</span>] <span class="op">-</span> spy[<span class="st">"Low_SPY"</span>]</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(spy[<span class="st">"High_SPY"</span>] <span class="op">-</span> spy[<span class="st">"prev_close"</span>])</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(spy[<span class="st">"Low_SPY"</span>] <span class="op">-</span> spy[<span class="st">"prev_close"</span>])</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"true_range"</span>] <span class="op">=</span> spy[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 10-day ATR</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"ATR_10"</span>] <span class="op">=</span> spy[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 4: Calculate ATR as a percentage of closing price ----</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"atr_pct"</span>] <span class="op">=</span> spy[<span class="st">"ATR_10"</span>] <span class="op">/</span> spy[<span class="st">"Close_SPY"</span>]</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="co"># allocating the capital</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:  <span class="co"># &lt; 3% volatility → low risk</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># allocate 1% of capital</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># ≥ 3% volatility → high risk</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># allocate 0.5% of capital</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"position_size"</span>] <span class="op">=</span> spy.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 6: Optional - Capital allocation per trade ----</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a><span class="co">#capital = 100000 # Example: $100K total portfolio</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a><span class="co">#spy["allocation_dollars"] = spy["position_size"] * capital</span></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(spy[[<span class="st">"Close_SPY"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Close_SPY    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  611.091675  4.794563  0.007846           0.01
2025-02-20  608.549377  4.806522  0.007898           0.01
2025-02-21  598.140686  5.513399  0.009218           0.01
2025-02-24  595.418884  5.359863  0.009002           0.01
2025-02-25  592.457764  5.718790  0.009653           0.01
2025-02-26  592.756836  6.146507  0.010369           0.01
2025-02-27  583.295288  6.801538  0.011661           0.01
2025-02-28  592.397949  7.353875  0.012414           0.01
2025-03-03  582.019165  8.901222  0.015294           0.01
2025-03-04  575.129883  9.901217  0.017216           0.01</code></pre>
</div>
</div>
<div id="cell-74" class="cell" data-execution_count="1438">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(spy, x<span class="op">=</span>spy.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time"</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-execution_count="1439">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only 2025 data</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>spy_2025 <span class="op">=</span> spy[spy.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(spy_2025, x<span class="op">=</span>spy_2025.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time (2025 Only)"</span>)</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="1440">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Without sentiment score</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>spy_copy <span class="op">=</span> spy.copy()</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>spy_copy[<span class="st">'atr_pct'</span>] <span class="op">=</span> spy_copy[<span class="st">'ATR_10'</span>] <span class="op">/</span> spy_copy[<span class="st">'Close_SPY'</span>]</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Buy Signal (assuming VI_Cross_Up is defined elsewhere)</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>spy_copy[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> spy_copy[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> spy_copy[<span class="st">'VI-_'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Sell Signal (basic)</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>spy_copy[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> spy_copy[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> spy_copy[<span class="st">'VI+_'</span>]</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize position state</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>spy_copy[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(spy_copy)):</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> spy_copy[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>        spy_copy.at[spy_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> spy_copy[<span class="st">'Close_SPY'</span>].iloc[i]</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> spy_copy[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> spy_copy[<span class="st">'Close_SPY'</span>].iloc[i]</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>            spy_copy.at[spy_copy.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># trailing stop</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>            spy_copy.at[spy_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>            spy_copy.at[spy_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-77" class="cell" data-execution_count="1441">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(spy_copy)):</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> spy_copy.iloc[i]</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_SPY'</span>]</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_SPY'</span>]</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Final capital</span></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_SPY'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100515.03
Total Return: $515.03
Total Trades: 56
Average Profit per Trade: $9.20</code></pre>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="1442">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vectorbt <span class="im">as</span> vbt</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> spy_copy.dropna(subset<span class="op">=</span>[<span class="st">'Close_SPY'</span>])</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> spy_copy[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> spy_copy[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> spy_copy[<span class="st">'Close_SPY'</span>]</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           149876.276862
Total Return [%]                        49.876277
Benchmark Return [%]                   153.411688
Max Gross Exposure [%]                      100.0
Total Fees Paid                      14500.399389
Max Drawdown [%]                        19.809422
Max Drawdown Duration                       584.0
Total Trades                                   56
Total Closed Trades                            56
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            55.357143
Best Trade [%]                           7.385103
Worst Trade [%]                         -9.885439
Avg Winning Trade [%]                    3.135412
Avg Losing Trade [%]                    -2.130086
Avg Winning Trade Duration              28.258065
Avg Losing Trade Duration                    7.56
Profit Factor                              1.7122
Expectancy                             890.647801
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
</section>
<section id="optimization" class="level2">
<h2 class="anchored" data-anchor-id="optimization">Optimization</h2>
<div id="cell-80" class="cell" data-execution_count="1443">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> yf.download(<span class="st">'TSLA'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> yf.download(<span class="st">'XLY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> yf.download(<span class="st">'SPY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-81" class="cell" data-execution_count="1444">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_vortex(df, value, n):</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate Vortex Indicator VI+ and VI-."""</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> df[(<span class="st">"High_"</span><span class="op">+</span>value)]</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    low <span class="op">=</span> df[(<span class="st">"Low_"</span><span class="op">+</span>value)]</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    close <span class="op">=</span> df[(<span class="st">"Close_"</span><span class="op">+</span>value)]</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    vm_plus <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low.shift(<span class="dv">1</span>))   <span class="co"># |Today's High - Yesterday's Low|</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    vm_minus <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> high.shift(<span class="dv">1</span>))  <span class="co"># |Today's Low - Yesterday's High|</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        high <span class="op">-</span> low,</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>)),</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    sum_vm_plus <span class="op">=</span> vm_plus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    sum_vm_minus <span class="op">=</span> vm_minus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>    sum_tr <span class="op">=</span> tr.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>    vi_plus <span class="op">=</span> sum_vm_plus <span class="op">/</span> sum_tr</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    vi_minus <span class="op">=</span> sum_vm_minus <span class="op">/</span> sum_tr</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vi_plus, vi_minus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-82" class="cell" data-execution_count="1445">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>tsla.columns <span class="op">=</span> [</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> tsla.columns</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-83" class="cell" data-execution_count="1446">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a list of different smoothing periods to test for the Vortex Indicator</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> [<span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">21</span>, <span class="dv">30</span>]</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> {}  <span class="co"># Dictionary to store performance metrics for each period</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each smoothing period</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> periods:</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Compute Vortex Indicator for the given period ===</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'VI+_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>], tsla[<span class="ss">f'VI-_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> calculate_vortex(tsla, <span class="st">'TSLA'</span>, n)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Generate Buy/Sell signals based on crossover logic ===</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy when VI+ crosses above VI-</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'Buy_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> tsla[<span class="ss">f'VI+_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI-_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell when VI- crosses above VI+</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'Sell_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> tsla[<span class="ss">f'VI-_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI+_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Convert boolean signals to actual entry/exit Series ===</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>    entries <span class="op">=</span> tsla[<span class="ss">f'Buy_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>    exits <span class="op">=</span> tsla[<span class="ss">f'Sell_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Run a backtest using vectorbt Portfolio object ===</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>    portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        close<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],  <span class="co"># TSLA closing prices</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        entries<span class="op">=</span>entries,</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>        exits<span class="op">=</span>exits,</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Assume buying 1 share per trade</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>        init_cash<span class="op">=</span><span class="dv">10_000</span>  <span class="co"># Initial capital for backtest</span></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Store backtest performance metrics in results dict ===</span></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> portfolio.stats()</span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>    results[n] <span class="op">=</span> stats</span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the period with the highest total return</span></span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>best_period <span class="op">=</span> <span class="bu">max</span>(results, key<span class="op">=</span><span class="kw">lambda</span> x: results[x][<span class="st">'Total Return [%]'</span>])</span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Best Performing Period: </span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild portfolio using the best period to visualize it</span></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>tsla[<span class="ss">f'VI+_</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI-_</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>tsla[<span class="ss">f'VI-_</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI+_</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">10_000</span></span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results of the best strategy</span></span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Best Performing Period: 7 days</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                               10000.0
End Value                            10480.194603
Total Return [%]                         4.801946
Benchmark Return [%]                  1215.813231
Max Gross Exposure [%]                   4.554966
Total Fees Paid                               0.0
Max Drawdown [%]                         0.793073
Max Drawdown Duration                       351.0
Total Trades                                  113
Total Closed Trades                           113
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            44.247788
Best Trade [%]                         128.434899
Worst Trade [%]                        -15.721837
Avg Winning Trade [%]                   14.052436
Avg Losing Trade [%]                    -4.125181
Avg Winning Trade Duration                  11.44
Avg Losing Trade Duration                4.206349
Profit Factor                            2.096188
Expectancy                                4.24951
dtype: object</code></pre>
</div>
</div>
</section>
<section id="peer-comparison-apple-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="peer-comparison-apple-analysis-results">Peer Comparison: Apple Analysis Results</h2>
<div id="cell-85" class="cell" data-execution_count="1447">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>appl <span class="op">=</span> yf.download(<span class="st">'AAPL'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-86" class="cell" data-execution_count="1448">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>appl.columns <span class="op">=</span> [</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> appl.columns</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-87" class="cell" data-execution_count="1449">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_vortex(df, value, n):</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate Vortex Indicator VI+ and VI-."""</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> df[(<span class="st">"High_"</span><span class="op">+</span>value)]</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    low <span class="op">=</span> df[(<span class="st">"Low_"</span><span class="op">+</span>value)]</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    close <span class="op">=</span> df[(<span class="st">"Close_"</span><span class="op">+</span>value)]</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    vm_plus <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low.shift(<span class="dv">1</span>))   <span class="co"># |Today's High - Yesterday's Low|</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    vm_minus <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> high.shift(<span class="dv">1</span>))  <span class="co"># |Today's Low - Yesterday's High|</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>        high <span class="op">-</span> low,</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>)),</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    sum_vm_plus <span class="op">=</span> vm_plus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    sum_vm_minus <span class="op">=</span> vm_minus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    sum_tr <span class="op">=</span> tr.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>    vi_plus <span class="op">=</span> sum_vm_plus <span class="op">/</span> sum_tr</span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>    vi_minus <span class="op">=</span> sum_vm_minus <span class="op">/</span> sum_tr</span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vi_plus, vi_minus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-88" class="cell" data-execution_count="1450">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'VI+_'</span>], appl[<span class="st">'VI-_'</span>] <span class="op">=</span> calculate_vortex(appl, <span class="st">'AAPL'</span>, <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-89" class="cell" data-execution_count="1451">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load from file</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"AAPL_sentiment_raw.json"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    sentiment_json <span class="op">=</span> json.load(f)</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feed</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>sentiment_feed <span class="op">=</span> sentiment_json.get(<span class="st">"feed"</span>, [])</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract useful fields</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> []</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> sentiment_feed:</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>        sentiment_data.append({</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"time_published"</span>: pd.to_datetime(item[<span class="st">"time_published"</span>]),</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_score"</span>: <span class="bu">float</span>(item[<span class="st">"overall_sentiment_score"</span>]),</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_label"</span>: item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">KeyError</span>, <span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>  <span class="co"># Skip malformed rows</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to DataFrame</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>sentiment_df <span class="op">=</span> pd.DataFrame(sentiment_data)</span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>sentiment_df.set_index(<span class="st">"time_published"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a><span class="co"># View result</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentiment_df.head())</span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sentiment_df.info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                     sentiment_score   sentiment_label
time_published                                        
2025-03-01 00:00:18         0.225994  Somewhat-Bullish
2025-02-28 22:06:00         0.291136  Somewhat-Bullish
2025-02-28 17:55:55         0.082801           Neutral
2025-02-28 17:00:45         0.374552           Bullish
2025-02-28 15:00:46         0.287114  Somewhat-Bullish
&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 669 entries, 2025-03-01 00:00:18 to 2025-01-15 14:45:51
Data columns (total 2 columns):
 #   Column           Non-Null Count  Dtype  
---  ------           --------------  -----  
 0   sentiment_score  669 non-null    float64
 1   sentiment_label  669 non-null    object 
dtypes: float64(1), object(1)
memory usage: 15.7+ KB
None</code></pre>
</div>
</div>
<div id="cell-90" class="cell" data-execution_count="1452">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> []</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> news_item <span class="kw">in</span> sentiment_json.get(<span class="st">"feed"</span>, []):</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    sentiment_data.append({</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"time_published"</span>: pd.to_datetime(news_item[<span class="st">"time_published"</span>]),</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_score"</span>: news_item[<span class="st">"overall_sentiment_score"</span>],</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sentiment_label"</span>: news_item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>sentiment_data <span class="op">=</span> pd.DataFrame(sentiment_data)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>sentiment_data[<span class="st">'time_published'</span>] <span class="op">=</span> sentiment_data[<span class="st">'time_published'</span>].dt.date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-91" class="cell" data-execution_count="1453">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_data[pd.to_datetime(sentiment_data[<span class="st">'time_published'</span>]).isin(appl.index)]</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered <span class="op">=</span> sentiment_scores_filtered.groupby(<span class="st">'time_published'</span>)[<span class="st">'sentiment_score'</span>].mean().reset_index()</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(sentiment_scores_filtered))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>31</code></pre>
</div>
</div>
<div id="cell-92" class="cell" data-execution_count="1454">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>appl_volume <span class="op">=</span> appl[(<span class="st">'Volume_AAPL'</span>)].reset_index()</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>appl_volume[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(appl_volume[<span class="st">'Date'</span>])</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>sentiment_scores_filtered[<span class="st">'time_published'</span>] <span class="op">=</span> pd.to_datetime(sentiment_scores_filtered[<span class="st">'time_published'</span>])</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(appl_volume, sentiment_scores_filtered, left_on<span class="op">=</span><span class="st">'Date'</span>, right_on<span class="op">=</span><span class="st">'time_published'</span>, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Weighted_Sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Volume_AAPL'</span>] <span class="op">*</span> merged_data[<span class="st">'sentiment_score'</span>]</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">=</span> merged_data[<span class="st">'Weighted_Sentiment'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Condition'</span>] <span class="op">=</span> merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>] <span class="op">=</span> merged_data[<span class="st">'5_day_avg_sentiment'</span>]<span class="op">/</span>merged_data[<span class="st">'Volume_AAPL'</span>].mean()</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>merged_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1454">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Volume_AAPL</th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">Weighted_Sentiment</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment</th>
<th data-quarto-table-cell-role="th">Buy_Condition</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment_norm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-01-15</td>
<td>39832000</td>
<td>2025-01-15</td>
<td>0.223177</td>
<td>8.889575e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-01-16</td>
<td>71759100</td>
<td>2025-01-16</td>
<td>0.237567</td>
<td>1.704756e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-01-17</td>
<td>68488300</td>
<td>2025-01-17</td>
<td>0.130304</td>
<td>8.924326e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-01-21</td>
<td>98070400</td>
<td>2025-01-21</td>
<td>0.169273</td>
<td>1.660064e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-01-22</td>
<td>64126500</td>
<td>2025-01-22</td>
<td>0.182421</td>
<td>1.169803e+07</td>
<td>1.263203e+07</td>
<td>True</td>
<td>0.231401</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-93" class="cell" data-execution_count="1455">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate True Range</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"prev_close"</span>] <span class="op">=</span> appl[<span class="st">"Close_AAPL"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"tr1"</span>] <span class="op">=</span> appl[<span class="st">"High_AAPL"</span>] <span class="op">-</span> appl[<span class="st">"Low_AAPL"</span>]</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(appl[<span class="st">"High_AAPL"</span>] <span class="op">-</span> appl[<span class="st">"prev_close"</span>])</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(appl[<span class="st">"Low_AAPL"</span>] <span class="op">-</span> appl[<span class="st">"prev_close"</span>])</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"true_range"</span>] <span class="op">=</span> appl[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 10-day ATR</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"ATR_10"</span>] <span class="op">=</span> appl[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 4: Calculate ATR as a percentage of closing price ----</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"atr_pct"</span>] <span class="op">=</span> appl[<span class="st">"ATR_10"</span>] <span class="op">/</span> appl[<span class="st">"Close_AAPL"</span>]</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a><span class="co"># allocating the capital</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:  <span class="co"># &lt; 3% volatility → low risk</span></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># allocate 1% of capital</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># ≥ 3% volatility → high risk</span></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># allocate 0.5% of capital</span></span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">"position_size"</span>] <span class="op">=</span> appl.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(appl[[<span class="st">"Close_AAPL"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_AAPL    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  244.869995  4.939392  0.020171           0.01
2025-02-20  245.830002  4.735891  0.019265           0.01
2025-02-21  245.550003  4.746260  0.019329           0.01
2025-02-24  247.100006  4.517000  0.018280           0.01
2025-02-25  247.039993  4.687000  0.018973           0.01
2025-02-26  240.360001  4.719998  0.019637           0.01
2025-02-27  237.300003  4.631998  0.019520           0.01
2025-02-28  241.839996  5.143999  0.021270           0.01
2025-03-03  238.029999  5.479999  0.023022           0.01
2025-03-04  235.929993  5.685001  0.024096           0.01</code></pre>
</div>
</div>
<div id="cell-94" class="cell" data-execution_count="1456">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(appl, x<span class="op">=</span>appl.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"AAPL ATR% Over Time"</span>)</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-95" class="cell" data-execution_count="1457">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only 2025 data</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>appl_2025 <span class="op">=</span> appl[appl.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(appl_2025, x<span class="op">=</span>appl_2025.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"AAPL ATR% Over Time (2025 Only)"</span>)</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-96" class="cell" data-execution_count="1458">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(merged_data, appl, on<span class="op">=</span><span class="st">'Date'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-97" class="cell" data-execution_count="1459">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'atr_pct'</span>] <span class="op">=</span> merged_data[<span class="st">'ATR_10'</span>] <span class="op">/</span> merged_data[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vortex crossover logic</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI-_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (merged_data[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> merged_data[<span class="st">'VI+_'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'VI-_'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> merged_data[<span class="st">'VI+_'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal &amp; state columns</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>  <span class="co"># aggressive/conservative</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trailing stop logic variables</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(merged_data)):</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> merged_data.index[i]</span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">or</span> row[<span class="st">'VI_Cross_Up'</span>] <span class="kw">or</span> row[<span class="st">'5_day_avg_sentiment_norm'</span>]<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>        merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entry Type: aggressive if ATR &lt; 3%, else conservative</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, check for trailing stop or VI cross down</span></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>            merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Show result counts</span></span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, merged_data[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, merged_data[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 28
Sell signals: 1
Aggressive entries: 23
Conservative entries: 5</code></pre>
</div>
</div>
<div id="cell-98" class="cell" data-execution_count="1460">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot merged_data closing price</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data.index, </span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'Close_AAPL'</span>], </span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>, </span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'merged_data Price'</span>, </span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggressive buys</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)].index,</span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Aggressive)'</span>,</span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'limegreen'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative buys</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)].index,</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[(merged_data[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Conservative)'</span>,</span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Sells</span></span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span>,</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, color<span class="op">=</span><span class="st">'red'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'merged_data Buy/Sell Signals Over Time'</span>,</span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Price (USD)'</span>,</span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span>,</span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">600</span></span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-execution_count="1461">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'Date' is datetime and set as index if needed</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(merged_data[<span class="st">'Date'</span>])</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5-day Avg Sentiment</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>,</span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ATR %</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[<span class="st">'Date'</span>],</span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[<span class="st">'atr_pct'</span>],</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'ATR %'</span>,</span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="st">'y2'</span>,</span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Highlight Buy Signal Dates (even though there are none now)</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'Date'</span>],</span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data.loc[merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>, symbol<span class="op">=</span><span class="st">'star'</span>),</span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dual axis layout</span></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"5-Day Sentiment vs ATR % (with Buy Signals)"</span>,</span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>),</span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a>    yaxis2<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'ATR %'</span>, overlaying<span class="op">=</span><span class="st">'y'</span>, side<span class="op">=</span><span class="st">'right'</span>),</span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="fl">0.01</span>, y<span class="op">=</span><span class="fl">0.99</span>),</span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb146-45"><a href="#cb146-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-46"><a href="#cb146-46" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-100" class="cell" data-execution_count="1462">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>merged_data.index, y<span class="op">=</span>merged_data[<span class="st">'Close_AAPL'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'merged_data Price'</span>))</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Buy markers</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Buy_Signal'</span>]].index,</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Buy_Signal'</span>]][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Sell markers</span></span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>merged_data[merged_data[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a>fig.update_layout(title<span class="op">=</span><span class="st">'XLY Buy &amp; Sell Signals'</span>, template<span class="op">=</span><span class="st">'plotly_white'</span>)</span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-101" class="cell" data-execution_count="1463">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []</span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(merged_data)):</span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> merged_data.iloc[i]</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy</span></span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value</span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds</span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)</span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Final capital</span></span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_AAPL'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100057.01
Total Return: $57.01
Total Trades: 1
Average Profit per Trade: $-24.62</code></pre>
</div>
</div>
<div id="cell-102" class="cell" data-execution_count="1464">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vectorbt <span class="im">as</span> vbt</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure index is datetime and 'Close_TSLA' exists</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> merged_data[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate entries and exits from your signals</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> merged_data[<span class="st">'Buy_Signal'</span>]</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> merged_data[<span class="st">'Sell_Signal'</span>]</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create portfolio</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span>np.nan,  <span class="co"># Let it auto-calculate position size if fixed capital</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span>,  <span class="co"># 0.1% per trade</span></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    slippage<span class="op">=</span><span class="fl">0.0005</span>  <span class="co"># Optional</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot portfolio value</span></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                              0.000000
End                               30.000000
Period                            31.000000
Start Value                   100000.000000
End Value                     100000.000000
Total Return [%]                   0.000000
Benchmark Return [%]               1.780762
Max Gross Exposure [%]             0.000000
Total Fees Paid                    0.000000
Max Drawdown [%]                        NaN
Max Drawdown Duration                   NaN
Total Trades                       0.000000
Total Closed Trades                0.000000
Total Open Trades                  0.000000
Open Trade PnL                     0.000000
Win Rate [%]                            NaN
Best Trade [%]                          NaN
Worst Trade [%]                         NaN
Avg Winning Trade [%]                   NaN
Avg Losing Trade [%]                    NaN
Avg Winning Trade Duration              NaN
Avg Losing Trade Duration               NaN
Profit Factor                           NaN
Expectancy                              NaN
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-103" class="cell" data-execution_count="1465">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>appl_ <span class="op">=</span> merged_data.dropna(subset<span class="op">=</span>[<span class="st">'Close_AAPL'</span>])</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> merged_data[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> merged_data[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> merged_data[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                              0.000000
End                               30.000000
Period                            31.000000
Start Value                   100000.000000
End Value                     105185.963339
Total Return [%]                   5.185963
Benchmark Return [%]               1.780762
Max Gross Exposure [%]           100.000000
Total Fees Paid                  294.586321
Max Drawdown [%]                   4.900568
Max Drawdown Duration             10.000000
Total Trades                       2.000000
Total Closed Trades                1.000000
Total Open Trades                  1.000000
Open Trade PnL                  7842.950122
Win Rate [%]                       0.000000
Best Trade [%]                    -2.659644
Worst Trade [%]                   -2.659644
Avg Winning Trade [%]                   NaN
Avg Losing Trade [%]              -2.659644
Avg Winning Trade Duration              NaN
Avg Losing Trade Duration          2.000000
Profit Factor                      0.000000
Expectancy                     -2656.986783
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<section id="without-sentiment" class="level3">
<h3 class="anchored" data-anchor-id="without-sentiment">Without Sentiment</h3>
<div id="cell-105" class="cell" data-execution_count="1466">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WITHOUT sentiment</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>appl_copy <span class="op">=</span> appl.copy()</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>appl_copy[<span class="st">'atr_pct'</span>] <span class="op">=</span> appl_copy[<span class="st">'ATR_10'</span>] <span class="op">/</span> appl_copy[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Buy Signal (assuming VI_Cross_Up is defined elsewhere)</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>appl_copy[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> appl_copy[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> appl_copy[<span class="st">'VI-_'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co"># + add any other buy conditions here...</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Sell Signal (basic)</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>appl_copy[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> appl_copy[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> appl_copy[<span class="st">'VI+_'</span>]</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize position state</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>appl_copy[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(appl_copy)):</span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> appl_copy[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>        appl_copy.at[appl_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> appl_copy[<span class="st">'Close_AAPL'</span>].iloc[i]</span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> appl_copy[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> appl_copy[<span class="st">'Close_AAPL'</span>].iloc[i]</span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a>            appl_copy.at[appl_copy.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># trailing stop</span></span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a>            appl_copy.at[appl_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>            appl_copy.at[appl_copy.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-106" class="cell" data-execution_count="1467">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>cash <span class="op">=</span> capital</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> []</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(appl_copy)):</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> appl_copy.iloc[i]</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>        position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>        shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">-=</span> position_value</span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>        proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>        cash <span class="op">+=</span> proceeds</span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a>        returns.append(profit)</span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a>        position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Final capital</span></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_AAPL'</span>] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $101607.34
Total Return: $1607.34
Total Trades: 66
Average Profit per Trade: $24.26</code></pre>
</div>
</div>
<div id="cell-107" class="cell" data-execution_count="1468">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vectorbt <span class="im">as</span> vbt</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>appl <span class="op">=</span> appl_copy.dropna(subset<span class="op">=</span>[<span class="st">'Close_AAPL'</span>])</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>entries <span class="op">=</span> appl_copy[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>exits <span class="op">=</span> appl_copy[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>price <span class="op">=</span> appl_copy[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>price,</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>entries,</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>exits,</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           381936.663857
Total Return [%]                       281.936664
Benchmark Return [%]                   526.354228
Max Gross Exposure [%]                      100.0
Total Fees Paid                      35759.568798
Max Drawdown [%]                        20.871703
Max Drawdown Duration                       351.0
Total Trades                                   67
Total Closed Trades                            66
Total Open Trades                               1
Open Trade PnL                        4424.594853
Win Rate [%]                            45.454545
Best Trade [%]                          41.284317
Worst Trade [%]                        -11.056921
Avg Winning Trade [%]                    8.072835
Avg Losing Trade [%]                    -2.459744
Avg Winning Trade Duration              24.766667
Avg Losing Trade Duration                6.222222
Profit Factor                            2.113946
Expectancy                            4204.728318
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/opt/anaconda3/lib/python3.11/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<p>Based on the results from applying the trading strategy to the Apple (AAPL) ticker, we can reasonably conclude that the strategy does work on peers like AAPL. The strategy delivered a total return of approximately 282% over the backtest period (2019–2025), compared to a benchmark return of about 526%, which indicates it captured a significant portion of the upward trend while actively managing trades. Although it underperformed the benchmark in absolute terms, this is typical of signal-driven strategies that trade in and out of the market. The profit factor of 2.11, expectancy of 4204, and a win rate of 45.5% suggest the strategy was profitable overall. Additionally, the drawdown was moderate (20.87%), reflecting a reasonable risk exposure relative to the potential reward.</p>
<p>The cumulative returns graph further supports this interpretation. The strategy closely follows the broader market trend, generating consistent gains and outperforming during certain periods. The trade PnL distribution shows a good number of winning trades with healthy profitability, and although there were losses, the downside was generally contained. Therefore, this peer comparison confirms that the strategy generalizes reasonably well beyond TSLA, making it a potentially viable approach for other high-liquidity technology stocks like AAPL.</p>
<div id="cell-109" class="cell" data-execution_count="1469">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'atr_pct'</span>] <span class="op">=</span> appl[<span class="st">'ATR_10'</span>] <span class="op">/</span> appl[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> appl[<span class="st">'VI+_'</span>] <span class="op">&gt;</span> appl[<span class="st">'VI-_'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> appl[<span class="st">'VI-_'</span>] <span class="op">&gt;</span> appl[<span class="st">'VI+_'</span>]</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize position state</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>appl[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(appl)):</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> appl[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>        appl.at[appl.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> appl[<span class="st">'Close_AAPL'</span>].iloc[i]</span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> appl[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> appl[<span class="st">'Close_AAPL'</span>].iloc[i]</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>            appl.at[appl.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># trailing stop</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>            appl.at[appl.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>            appl.at[appl.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, appl[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, appl[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 985
Sell signals: 552</code></pre>
</div>
</div>
<div id="cell-110" class="cell" data-execution_count="1470">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>appl.index, y<span class="op">=</span>appl[<span class="st">'Close_AAPL'</span>], mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'AAPL Price'</span>))</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Buy markers</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>appl[appl[<span class="st">'Buy_Signal'</span>]].index,</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>appl[appl[<span class="st">'Buy_Signal'</span>]][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Sell markers</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>appl[appl[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>appl[appl[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_AAPL'</span>],</span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a>fig.update_layout(title<span class="op">=</span><span class="st">'AAPL Buy &amp; Sell Signals'</span>, template<span class="op">=</span><span class="st">'plotly_white'</span>)</span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
</section>
</section>
<section id="vi-plots" class="level2">
<h2 class="anchored" data-anchor-id="vi-plots">VI Plots</h2>
<div id="cell-112" class="cell" data-execution_count="1471">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> yf.download(<span class="st">'TSLA'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> yf.download(<span class="st">'XLY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> yf.download(<span class="st">'SPY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-113" class="cell" data-execution_count="1472">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_vortex(df, value, n<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> df[(<span class="st">"High"</span>, value)]</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>    low <span class="op">=</span> df[(<span class="st">"Low"</span>, value)]</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>    close <span class="op">=</span> df[(<span class="st">"Close"</span>, value)]</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate VM+ and VM-</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    vm_plus <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low.shift(<span class="dv">1</span>))   <span class="co"># |Today's High - Yesterday's Low|</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>    vm_minus <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> high.shift(<span class="dv">1</span>))  <span class="co"># |Today's Low - Yesterday's High|</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate True Range (TR)</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>        high <span class="op">-</span> low,</span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>)),</span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling sum for lookback period</span></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>    sum_vm_plus <span class="op">=</span> vm_plus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>    sum_vm_minus <span class="op">=</span> vm_minus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>    sum_tr <span class="op">=</span> tr.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute VI+ and VI-</span></span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>    vi_plus <span class="op">=</span> sum_vm_plus <span class="op">/</span> sum_tr</span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>    vi_minus <span class="op">=</span> sum_vm_minus <span class="op">/</span> sum_tr</span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vi_plus, vi_minus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-114" class="cell" data-execution_count="1473">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI+'</span>], tsla[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">'VI+'</span>], xly[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(xly, <span class="st">'XLY'</span>)</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">'VI+'</span>], spy[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(spy, <span class="st">'SPY'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-115" class="cell" data-execution_count="1474">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten MultiIndex columns </span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>tsla.columns <span class="op">=</span> [</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'_'</span>.join(col).strip() <span class="cf">if</span> <span class="bu">isinstance</span>(col, <span class="bu">tuple</span>) <span class="cf">else</span> col</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> tsla.columns</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate True Range</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"prev_close"</span>] <span class="op">=</span> tsla[<span class="st">"Close_TSLA"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr1"</span>] <span class="op">=</span> tsla[<span class="st">"High_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"Low_TSLA"</span>]</span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(tsla[<span class="st">"High_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"prev_close"</span>])</span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(tsla[<span class="st">"Low_TSLA"</span>] <span class="op">-</span> tsla[<span class="st">"prev_close"</span>])</span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"true_range"</span>] <span class="op">=</span> tsla[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 10-day ATR</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"ATR_10"</span>] <span class="op">=</span> tsla[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 4: Calculate ATR as a percentage of closing price ----</span></span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"atr_pct"</span>] <span class="op">=</span> tsla[<span class="st">"ATR_10"</span>] <span class="op">/</span> tsla[<span class="st">"Close_TSLA"</span>]</span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a><span class="co"># allocating the capital</span></span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:  <span class="co"># &lt; 3% volatility → low risk</span></span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># allocate 1% of capital</span></span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># ≥ 3% volatility → high risk</span></span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># allocate 0.5% of capital</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"position_size"</span>] <span class="op">=</span> tsla.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- STEP 6: Optional - Capital allocation per trade ----</span></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a><span class="co">#capital = 100000 # Example: $100K total portfolio</span></span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a><span class="co">#tsla["allocation_dollars"] = tsla["position_size"] * capital</span></span>
<span id="cb176-35"><a href="#cb176-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-36"><a href="#cb176-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb176-37"><a href="#cb176-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla[[<span class="st">"Close_TSLA"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_TSLA     ATR_10   atr_pct  position_size
Date                                                      
2025-02-19  360.559998  16.703000  0.046325          0.005
2025-02-20  354.399994  16.464999  0.046459          0.005
2025-02-21  337.799988  17.021997  0.050391          0.005
2025-02-24  330.529999  16.770996  0.050740          0.005
2025-02-25  302.799988  18.879996  0.062351          0.005
2025-02-26  290.799988  18.412994  0.063318          0.005
2025-02-27  281.950012  18.257996  0.064756          0.005
2025-02-28  292.980011  18.067996  0.061670          0.005
2025-03-03  284.649994  19.281998  0.067739          0.005
2025-03-04  272.040009  20.654996  0.075926          0.005</code></pre>
</div>
</div>
<div id="cell-116" class="cell" data-execution_count="1475">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(tsla, x<span class="op">=</span>tsla.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time"</span>)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/anaconda3/lib/python3.11/site-packages/_plotly_utils/basevalidators.py:106: FutureWarning:

The behavior of DatetimeProperties.to_pydatetime is deprecated, in a future version this will return a Series containing python datetime objects instead of an ndarray. To retain the old behavior, call `np.array` on the result
</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-117" class="cell" data-execution_count="1476">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">"VI+_"</span>],</span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+_'</span>,</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">"VI-_"</span>],</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-_'</span>,</span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for TSLA"</span>,</span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-118" class="cell" data-execution_count="1477">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>tsla_2025 <span class="op">=</span> tsla.loc[<span class="st">"2025"</span>]</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_2025[<span class="st">"VI+_"</span>],</span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+'</span>,</span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_2025[<span class="st">"VI-_"</span>],</span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-'</span>,</span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for TSLA - 2025"</span>,</span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-119" class="cell" data-execution_count="1478">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy.index,</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy[<span class="st">"VI+"</span>],</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+'</span>,</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy.index,</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy[<span class="st">"VI-"</span>],</span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-'</span>,</span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for SPY"</span>,</span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-27"><a href="#cb185-27" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-120" class="cell" data-execution_count="1479">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>spy_2025 <span class="op">=</span> spy.loc[<span class="st">"2025"</span>]</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy_2025.index,</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy_2025[<span class="st">"VI+"</span>],</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+'</span>,</span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy_2025.index,</span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy_2025[<span class="st">"VI-"</span>],</span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-'</span>,</span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for SPY - 2025"</span>,</span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-121" class="cell" data-execution_count="1480">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly.index,</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly[<span class="st">"VI+"</span>],</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+'</span>,</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly.index,</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly[<span class="st">"VI-"</span>],</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-'</span>,</span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for XLY"</span>,</span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-122" class="cell" data-execution_count="1481">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>xly_2025 <span class="op">=</span> xly.loc[<span class="st">"2025"</span>]</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly_2025.index,</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly_2025[<span class="st">"VI+"</span>],</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI+'</span>,</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly_2025.index,</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly_2025[<span class="st">"VI-"</span>],</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'VI-'</span>,</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) for XLY - 2025"</span>,</span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Date"</span>,</span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Value"</span>,</span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="dv">0</span>, y<span class="op">=</span><span class="fl">1.1</span>, orientation<span class="op">=</span><span class="st">"h"</span>),</span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-123" class="cell" data-execution_count="1482">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    rows<span class="op">=</span><span class="dv">3</span>, cols<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    subplot_titles<span class="op">=</span>(<span class="st">"SPY - 2025"</span>, <span class="st">"XLY - 2025"</span>, <span class="st">"TSLA - 2025"</span>)</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy_2025.index,</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy_2025[<span class="st">"VI+"</span>],</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (SPY)"</span>,</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy_2025.index,</span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy_2025[<span class="st">"VI-"</span>],</span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (SPY)"</span>,</span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly_2025.index,</span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly_2025[<span class="st">"VI+"</span>],</span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (XLY)"</span>,</span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly_2025.index,</span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly_2025[<span class="st">"VI-"</span>],</span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (XLY)"</span>,</span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb193-37"><a href="#cb193-37" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-38"><a href="#cb193-38" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-39"><a href="#cb193-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-40"><a href="#cb193-40" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-41"><a href="#cb193-41" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb193-42"><a href="#cb193-42" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_2025[<span class="st">"VI+_"</span>],</span>
<span id="cb193-43"><a href="#cb193-43" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (TSLA)"</span>,</span>
<span id="cb193-44"><a href="#cb193-44" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb193-45"><a href="#cb193-45" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-46"><a href="#cb193-46" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-47"><a href="#cb193-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-48"><a href="#cb193-48" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb193-49"><a href="#cb193-49" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb193-50"><a href="#cb193-50" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_2025[<span class="st">"VI-_"</span>],</span>
<span id="cb193-51"><a href="#cb193-51" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (TSLA)"</span>,</span>
<span id="cb193-52"><a href="#cb193-52" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb193-53"><a href="#cb193-53" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb193-54"><a href="#cb193-54" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-55"><a href="#cb193-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-56"><a href="#cb193-56" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb193-57"><a href="#cb193-57" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span>, width<span class="op">=</span><span class="dv">1200</span>,</span>
<span id="cb193-58"><a href="#cb193-58" aria-hidden="true" tabindex="-1"></a>    title_text<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) - 2025 Comparison"</span>,</span>
<span id="cb193-59"><a href="#cb193-59" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb193-60"><a href="#cb193-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb193-61"><a href="#cb193-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-62"><a href="#cb193-62" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>
<div id="cell-124" class="cell" data-execution_count="1483">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    rows<span class="op">=</span><span class="dv">3</span>, cols<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    subplot_titles<span class="op">=</span>(<span class="st">"SPY Year To Year"</span>, <span class="st">"XLY Year To Year"</span>, <span class="st">"TSLA Year To Year"</span>)</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy.index,</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy[<span class="st">"VI+"</span>],</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (SPY)"</span>,</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>spy.index,</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>spy[<span class="st">"VI-"</span>],</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (SPY)"</span>,</span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">1</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly.index,</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly[<span class="st">"VI+"</span>],</span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (XLY)"</span>,</span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>xly.index,</span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>xly[<span class="st">"VI-"</span>],</span>
<span id="cb195-33"><a href="#cb195-33" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (XLY)"</span>,</span>
<span id="cb195-34"><a href="#cb195-34" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb195-35"><a href="#cb195-35" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-36"><a href="#cb195-36" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">2</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-37"><a href="#cb195-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-38"><a href="#cb195-38" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-39"><a href="#cb195-39" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb195-40"><a href="#cb195-40" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">"VI+_"</span>],</span>
<span id="cb195-41"><a href="#cb195-41" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI+ (TSLA)"</span>,</span>
<span id="cb195-42"><a href="#cb195-42" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb195-43"><a href="#cb195-43" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-44"><a href="#cb195-44" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-45"><a href="#cb195-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-46"><a href="#cb195-46" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb195-47"><a href="#cb195-47" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb195-48"><a href="#cb195-48" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">"VI-_"</span>],</span>
<span id="cb195-49"><a href="#cb195-49" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"VI- (TSLA)"</span>,</span>
<span id="cb195-50"><a href="#cb195-50" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>),</span>
<span id="cb195-51"><a href="#cb195-51" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">False</span></span>
<span id="cb195-52"><a href="#cb195-52" aria-hidden="true" tabindex="-1"></a>), row<span class="op">=</span><span class="dv">3</span>, col<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb195-53"><a href="#cb195-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-54"><a href="#cb195-54" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb195-55"><a href="#cb195-55" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">900</span>, width<span class="op">=</span><span class="dv">1200</span>,</span>
<span id="cb195-56"><a href="#cb195-56" aria-hidden="true" tabindex="-1"></a>    title_text<span class="op">=</span><span class="st">"Vortex Indicator (VI+ and VI−) - Full Period Comparison"</span>,</span>
<span id="cb195-57"><a href="#cb195-57" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">"plotly_white"</span></span>
<span id="cb195-58"><a href="#cb195-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb195-59"><a href="#cb195-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-60"><a href="#cb195-60" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.plotly.v1+json</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>