<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Group Data Oracles">

<title>Vortex–Sentiment Adaptive Volatility (VSAV) Strategy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="main_files/libs/clipboard/clipboard.min.js"></script>
<script src="main_files/libs/quarto-html/quarto.js"></script>
<script src="main_files/libs/quarto-html/popper.min.js"></script>
<script src="main_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="main_files/libs/quarto-html/anchor.min.js"></script>
<link href="main_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="main_files/libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="main_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="main_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="main_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#importing-necessary-libraries-for-analysis" id="toc-importing-necessary-libraries-for-analysis" class="nav-link active" data-scroll-target="#importing-necessary-libraries-for-analysis">Importing Necessary Libraries for Analysis</a></li>
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">Data Collection</a>
  <ul class="collapse">
  <li><a href="#fetch-daily-ohlcv-data" id="toc-fetch-daily-ohlcv-data" class="nav-link" data-scroll-target="#fetch-daily-ohlcv-data">Fetch daily OHLCV data</a></li>
  <li><a href="#fetch-sentiment-scores-from-the-api" id="toc-fetch-sentiment-scores-from-the-api" class="nav-link" data-scroll-target="#fetch-sentiment-scores-from-the-api">Fetch sentiment scores from the API</a></li>
  </ul></li>
  <li><a href="#indicator-calculation" id="toc-indicator-calculation" class="nav-link" data-scroll-target="#indicator-calculation">Indicator Calculation</a>
  <ul class="collapse">
  <li><a href="#compute-vi-and-vi-" id="toc-compute-vi-and-vi-" class="nav-link" data-scroll-target="#compute-vi-and-vi-">Compute VI+ and VI-</a></li>
  <li><a href="#calculate-volume-weighted-sentiment" id="toc-calculate-volume-weighted-sentiment" class="nav-link" data-scroll-target="#calculate-volume-weighted-sentiment">Calculate Volume-Weighted Sentiment</a></li>
  <li><a href="#derive-atr-10-for-volatility-adjustments" id="toc-derive-atr-10-for-volatility-adjustments" class="nav-link" data-scroll-target="#derive-atr-10-for-volatility-adjustments">Derive ATR (10) for Volatility Adjustments</a></li>
  </ul></li>
  <li><a href="#tesla-analysis-results" id="toc-tesla-analysis-results" class="nav-link" data-scroll-target="#tesla-analysis-results">Tesla Analysis Results</a></li>
  <li><a href="#xly-analysis-results" id="toc-xly-analysis-results" class="nav-link" data-scroll-target="#xly-analysis-results">XLY Analysis Results</a></li>
  <li><a href="#spy-analysis-results" id="toc-spy-analysis-results" class="nav-link" data-scroll-target="#spy-analysis-results">SPY Analysis Results</a></li>
  <li><a href="#optimization-tsla" id="toc-optimization-tsla" class="nav-link" data-scroll-target="#optimization-tsla">Optimization (TSLA)</a></li>
  <li><a href="#peer-comparison-apple-analysis-results" id="toc-peer-comparison-apple-analysis-results" class="nav-link" data-scroll-target="#peer-comparison-apple-analysis-results">Peer Comparison: Apple Analysis Results</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Vortex–Sentiment Adaptive Volatility (VSAV) Strategy</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Group Data Oracles </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Boston University
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  


</header>


<section id="importing-necessary-libraries-for-analysis" class="level2">
<h2 class="anchored" data-anchor-id="importing-necessary-libraries-for-analysis">Importing Necessary Libraries for Analysis</h2>
<div id="cell-2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf  <span class="co"># For downloading financial data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np      <span class="co"># For numerical operations</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd     <span class="co"># For data manipulation</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests <span class="co"># For downloading the API data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px <span class="co"># Import the Plotly Express module for interactive visualization</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vectorbt <span class="im">as</span> vbt</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.io <span class="im">as</span> pio</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pio.renderers.default <span class="op">=</span> <span class="st">'iframe_connected'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(</code></pre>
</div>
</div>
</section>
<section id="data-collection" class="level2">
<h2 class="anchored" data-anchor-id="data-collection">Data Collection</h2>
<section id="fetch-daily-ohlcv-data" class="level3">
<h3 class="anchored" data-anchor-id="fetch-daily-ohlcv-data">Fetch daily OHLCV data</h3>
<div id="cell-5" class="cell" data-outputid="d2b18763-b874-471e-fd06-1cc141c449e3" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for the TSLA, XLY, and SPY tickers is retrieved from the Yahoo Finance library, covering the period from January 1, 2019, </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to March 5, 2025.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> yf.download(<span class="st">'TSLA'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>) </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> yf.download(<span class="st">'XLY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> yf.download(<span class="st">'SPY'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>YF.download() has changed argument auto_adjust default to True</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed
[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> multiindex_to_singleindex(df):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> [<span class="st">'_'</span>.join(col).strip() <span class="cf">for</span> col <span class="kw">in</span> df.columns.values]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-7" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> multiindex_to_singleindex(tsla)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> multiindex_to_singleindex(spy)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> multiindex_to_singleindex(xly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell" data-outputid="ffaa84e9-b819-44a7-f26e-e2a55a32d83e" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the TSLA DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>tsla.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column       Non-Null Count  Dtype  
---  ------       --------------  -----  
 0   Close_TSLA   1551 non-null   float64
 1   High_TSLA    1551 non-null   float64
 2   Low_TSLA     1551 non-null   float64
 3   Open_TSLA    1551 non-null   float64
 4   Volume_TSLA  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
<div id="cell-9" class="cell" data-outputid="6e7bc69d-4e6d-421f-99e7-c4ad1fb3ad76" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the XLY DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>xly.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   Close_XLY   1551 non-null   float64
 1   High_XLY    1551 non-null   float64
 2   Low_XLY     1551 non-null   float64
 3   Open_XLY    1551 non-null   float64
 4   Volume_XLY  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays a summary of the SPY DataFrame, including column names, data types, non-null counts, and memory usage.</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>spy.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
DatetimeIndex: 1551 entries, 2019-01-02 to 2025-03-04
Data columns (total 5 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   Close_SPY   1551 non-null   float64
 1   High_SPY    1551 non-null   float64
 2   Low_SPY     1551 non-null   float64
 3   Open_SPY    1551 non-null   float64
 4   Volume_SPY  1551 non-null   int64  
dtypes: float64(4), int64(1)
memory usage: 72.7 KB</code></pre>
</div>
</div>
</section>
<section id="fetch-sentiment-scores-from-the-api" class="level3">
<h3 class="anchored" data-anchor-id="fetch-sentiment-scores-from-the-api">Fetch sentiment scores from the API</h3>
<div id="cell-12" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_news_sentiment(ticker, start_date, end_date, limit, api_key):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="ss">f'https://www.alphavantage.co/query?function=NEWS_SENTIMENT&amp;time_from=</span><span class="sc">{</span>start_date<span class="sc">}</span><span class="ss">&amp;time_to=</span><span class="sc">{</span>end_date<span class="sc">}</span><span class="ss">&amp;limit=</span><span class="sc">{</span>limit<span class="sc">}</span><span class="ss">&amp;tickers=</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">&amp;apikey=</span><span class="sc">{</span>api_key<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.get(url)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        sentiment_data <span class="op">=</span> response.json()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">_sentiment_raw.json'</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>            json.dump(sentiment_data, f, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sentiment_df = pd.DataFrame(sentiment_data['feed'])</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Full sentiment JSON saved ✅"</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"API call failed:"</span>, response.status_code)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-13" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>get_news_sentiment(<span class="st">'TSLA'</span>, <span class="st">'20250101T0130'</span>, <span class="st">'20250301T0130'</span>, <span class="dv">1000</span>, <span class="st">'PNM5EHRALIOT1CKJ'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>'Full sentiment JSON saved ✅'</code></pre>
</div>
</div>
</section>
</section>
<section id="indicator-calculation" class="level2">
<h2 class="anchored" data-anchor-id="indicator-calculation">Indicator Calculation</h2>
<section id="compute-vi-and-vi-" class="level3">
<h3 class="anchored" data-anchor-id="compute-vi-and-vi-">Compute VI+ and VI-</h3>
<div id="cell-16" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defines a function to calculate the Vortex Indicator (VI) for a given DataFrame and ticker symbol.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The calculation uses a default lookback period of 14 days unless specified otherwise.</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_vortex(df, value, n<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extracts the high, low, and close price series for the specified ticker.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    high <span class="op">=</span> df[(<span class="st">"High_"</span><span class="op">+</span>value)]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    low <span class="op">=</span> df[(<span class="st">"Low_"</span><span class="op">+</span>value)]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    close <span class="op">=</span> df[(<span class="st">"Close_"</span><span class="op">+</span>value)]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculates the Vortex Movement values:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VM+ = absolute difference between today's high and yesterday's low</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VM− = absolute difference between today's low and yesterday's high</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    vm_plus <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low.shift(<span class="dv">1</span>))     <span class="co"># |Today's High – Yesterday’s Low|</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    vm_minus <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> high.shift(<span class="dv">1</span>))    <span class="co"># |Today's Low – Yesterday’s High|</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Computes the True Range (TR) as the maximum of:</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - High - Low</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Absolute difference between High and Previous Close</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - Absolute difference between Low and Previous Close</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        high <span class="op">-</span> low,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>)),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    ], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Applies a rolling window to compute the n-period sum of VM+ and VM− values</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and the corresponding True Range values.</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    sum_vm_plus <span class="op">=</span> vm_plus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    sum_vm_minus <span class="op">=</span> vm_minus.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    sum_tr <span class="op">=</span> tr.rolling(window<span class="op">=</span>n).<span class="bu">sum</span>()</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculates the Vortex Indicator components:</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VI+ = sum of VM+ over n periods divided by sum of TR over n periods</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VI− = sum of VM− over n periods divided by sum of TR over n periods</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    vi_plus <span class="op">=</span> sum_vm_plus <span class="op">/</span> sum_tr</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    vi_minus <span class="op">=</span> sum_vm_minus <span class="op">/</span> sum_tr</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns the VI+ and VI− series as output.</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vi_plus, vi_minus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-17" class="cell" data-outputid="d20f0c8a-1822-4449-8396-a9d5113f3deb" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for TSLA and stores the results as new columns in the DataFrame.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI+'</span>], tsla[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for XLY and stores the results as new columns in the DataFrame.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">'VI+'</span>], xly[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(xly, <span class="st">'XLY'</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculates the Vortex Indicator values for SPY and stores the results as new columns in the DataFrame.</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">'VI+'</span>], spy[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(spy, <span class="st">'SPY'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-18" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Displays the first 20 rows of the TSLA DataFrame to provide an initial overview of its structure and content with the new function applied.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>tsla.head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Close_TSLA</th>
<th data-quarto-table-cell-role="th">High_TSLA</th>
<th data-quarto-table-cell-role="th">Low_TSLA</th>
<th data-quarto-table-cell-role="th">Open_TSLA</th>
<th data-quarto-table-cell-role="th">Volume_TSLA</th>
<th data-quarto-table-cell-role="th">VI+</th>
<th data-quarto-table-cell-role="th">VI-</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-02</td>
<td>20.674667</td>
<td>21.008667</td>
<td>19.920000</td>
<td>20.406668</td>
<td>174879000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-03</td>
<td>20.024000</td>
<td>20.626667</td>
<td>19.825333</td>
<td>20.466667</td>
<td>104478000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-04</td>
<td>21.179333</td>
<td>21.200001</td>
<td>20.181999</td>
<td>20.400000</td>
<td>110911500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-07</td>
<td>22.330667</td>
<td>22.449333</td>
<td>21.183332</td>
<td>21.448000</td>
<td>113268000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-08</td>
<td>22.356667</td>
<td>22.934000</td>
<td>21.801332</td>
<td>22.797333</td>
<td>105127500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-09</td>
<td>22.568666</td>
<td>22.900000</td>
<td>22.098000</td>
<td>22.366667</td>
<td>81493500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-10</td>
<td>22.997999</td>
<td>23.025999</td>
<td>22.119333</td>
<td>22.293333</td>
<td>90846000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-11</td>
<td>23.150667</td>
<td>23.227333</td>
<td>22.584667</td>
<td>22.806000</td>
<td>75586500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-14</td>
<td>22.293333</td>
<td>22.833332</td>
<td>22.266666</td>
<td>22.825333</td>
<td>78709500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-15</td>
<td>22.962000</td>
<td>23.253332</td>
<td>22.299999</td>
<td>22.333332</td>
<td>90849000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-16</td>
<td>23.070000</td>
<td>23.466667</td>
<td>22.900000</td>
<td>22.985332</td>
<td>70375500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-17</td>
<td>23.153999</td>
<td>23.433332</td>
<td>22.943333</td>
<td>23.080667</td>
<td>55150500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-18</td>
<td>20.150667</td>
<td>21.808666</td>
<td>19.982000</td>
<td>21.533333</td>
<td>362262000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-22</td>
<td>19.927999</td>
<td>20.533333</td>
<td>19.700001</td>
<td>20.321333</td>
<td>181000500</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-23</td>
<td>19.172667</td>
<td>19.633333</td>
<td>18.779333</td>
<td>19.500000</td>
<td>187950000</td>
<td>0.938520</td>
<td>0.946160</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-24</td>
<td>19.434000</td>
<td>19.578667</td>
<td>18.618668</td>
<td>18.868668</td>
<td>120183000</td>
<td>0.937771</td>
<td>0.927867</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-25</td>
<td>19.802668</td>
<td>19.901333</td>
<td>19.303333</td>
<td>19.625999</td>
<td>108744000</td>
<td>0.969095</td>
<td>0.953411</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-28</td>
<td>19.758667</td>
<td>19.830667</td>
<td>19.183332</td>
<td>19.527332</td>
<td>96349500</td>
<td>0.886399</td>
<td>1.047633</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2019-01-29</td>
<td>19.830667</td>
<td>19.903999</td>
<td>19.453333</td>
<td>19.684668</td>
<td>69325500</td>
<td>0.853825</td>
<td>1.081611</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2019-01-30</td>
<td>20.584667</td>
<td>20.600000</td>
<td>19.899332</td>
<td>20.030001</td>
<td>168754500</td>
<td>0.859650</td>
<td>1.020518</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="calculate-volume-weighted-sentiment" class="level3">
<h3 class="anchored" data-anchor-id="calculate-volume-weighted-sentiment">Calculate Volume-Weighted Sentiment</h3>
<div id="cell-20" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> json_reader(ticker):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f'</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">_sentiment_raw.json'</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        sentiment_json_ticker <span class="op">=</span> json.load(f)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        sentiment_feed <span class="op">=</span> sentiment_json_ticker.get(<span class="st">"feed"</span>, [])</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        sentiment_data <span class="op">=</span> []</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Iterate through each item in the sentiment feed to extract relevant fields</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> sentiment_feed:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                sentiment_data.append({</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert the timestamp to pandas datetime for proper indexing</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"time_published"</span>: pd.to_datetime(item[<span class="st">"time_published"</span>]),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Convert the sentiment score string to float</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"sentiment_score"</span>: <span class="bu">float</span>(item[<span class="st">"overall_sentiment_score"</span>]),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store the sentiment label (e.g., Positive, Neutral, Negative)</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"sentiment_label"</span>: item[<span class="st">"overall_sentiment_label"</span>],</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> (<span class="pp">KeyError</span>, <span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Skip malformed or incomplete entries that raise an error</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span>    </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the structured list of dictionaries into a pandas DataFrame</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        sentiment_df <span class="op">=</span> pd.DataFrame(sentiment_data)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set the 'time_published' column as the DataFrame index to enable time-series operations</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sentiment_df.set_index("time_published", inplace=True)</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        sentiment_df[<span class="st">'time_published'</span>]<span class="op">=</span> pd.to_datetime(sentiment_df[<span class="st">'time_published'</span>].dt.date)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sentiment_df</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># globals()[f"{ticker.lower()}_sentiment_data"] = sentiment_data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-21" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>tsla_sentiment_df <span class="op">=</span> json_reader(<span class="st">'TSLA'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-22" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tsla_sentiment_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">sentiment_label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-03-01</td>
<td>0.225994</td>
<td>Somewhat-Bullish</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-02-28</td>
<td>-0.098739</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-02-28</td>
<td>-0.041235</td>
<td>Neutral</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-02-28</td>
<td>-0.038786</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-02-28</td>
<td>0.021961</td>
<td>Neutral</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tsla_sentiment_scores_filtered <span class="op">=</span> tsla_sentiment_df[(tsla_sentiment_df[<span class="st">'time_published'</span>]).isin(tsla.index)]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>tsla_sentiment_scores_filtered <span class="op">=</span> tsla_sentiment_scores_filtered.groupby(<span class="st">'time_published'</span>)[<span class="st">'sentiment_score'</span>].mean().reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-24" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tsla_merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="st">'Volume_TSLA'</span>].reset_index().rename(columns<span class="op">=</span>{<span class="st">'Volume_TSLA'</span>: <span class="st">'Volume'</span>}),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    tsla_sentiment_scores_filtered,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'time_published'</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted sentiment by multiplying raw sentiment by trading volume</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Weighted_Sentiment'</span>] <span class="op">=</span> tsla_merged_data[<span class="st">'Volume'</span>] <span class="op">*</span> tsla_merged_data[<span class="st">'sentiment_score'</span>]</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate a 5-day rolling average of the weighted sentiment to smooth short-term noise</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">=</span> tsla_merged_data[<span class="st">'Weighted_Sentiment'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a binary condition for when the average sentiment is positive</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Buy_Condition'</span>] <span class="op">=</span> tsla_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the rolling sentiment score by average volume to allow comparability across scales</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>] <span class="op">=</span> (</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    tsla_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">/</span> tsla_merged_data[<span class="st">'Volume'</span>].mean()</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-25" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>tsla_merged_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">Weighted_Sentiment</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment</th>
<th data-quarto-table-cell-role="th">Buy_Condition</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment_norm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-01-31</td>
<td>83568200</td>
<td>2025-01-31</td>
<td>0.194614</td>
<td>1.626354e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-02-03</td>
<td>93732100</td>
<td>2025-02-03</td>
<td>0.129243</td>
<td>1.211426e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-02-04</td>
<td>57072200</td>
<td>2025-02-04</td>
<td>0.173107</td>
<td>9.879602e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-02-05</td>
<td>57223300</td>
<td>2025-02-05</td>
<td>0.136874</td>
<td>7.832396e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-02-06</td>
<td>77918200</td>
<td>2025-02-06</td>
<td>0.118095</td>
<td>9.201782e+06</td>
<td>1.105832e+07</td>
<td>True</td>
<td>0.132787</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="derive-atr-10-for-volatility-adjustments" class="level3">
<h3 class="anchored" data-anchor-id="derive-atr-10-for-volatility-adjustments">Derive ATR (10) for Volatility Adjustments</h3>
<div id="cell-27" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_true_range(df, ticker):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"prev_close"</span>] <span class="op">=</span> df[<span class="ss">f'Close_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"tr1"</span>] <span class="op">=</span> df[<span class="ss">f'High_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>] <span class="op">-</span> df[<span class="ss">f'Low_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"tr2"</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="ss">f'High_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>] <span class="op">-</span> df[<span class="st">"prev_close"</span>])</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"tr3"</span>] <span class="op">=</span> <span class="bu">abs</span>(df[<span class="ss">f'Low_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>] <span class="op">-</span> df[<span class="st">"prev_close"</span>])</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"true_range"</span>] <span class="op">=</span> df[[<span class="st">"tr1"</span>, <span class="st">"tr2"</span>, <span class="st">"tr3"</span>]].<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ATR_10"</span>] <span class="op">=</span> df[<span class="st">"true_range"</span>].rolling(window<span class="op">=</span><span class="dv">10</span>).mean()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"atr_pct"</span>] <span class="op">=</span> df[<span class="st">"ATR_10"</span>] <span class="op">/</span> df[<span class="ss">f'Close_</span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> position_size(row):</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"atr_pct"</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:  <span class="co"># &lt; 3% volatility → low risk</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.01</span>  <span class="co"># allocate 1% of capital</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># ≥ 3% volatility → high risk</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.005</span>  <span class="co"># allocate 0.5% of capital</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-28" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> calculate_true_range(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">"position_size"</span>] <span class="op">=</span> tsla.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla[[<span class="st">"Close_TSLA"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_TSLA     ATR_10   atr_pct  position_size
Date                                                      
2025-02-19  360.559998  16.703000  0.046325          0.005
2025-02-20  354.399994  16.464999  0.046459          0.005
2025-02-21  337.799988  17.021997  0.050391          0.005
2025-02-24  330.529999  16.770996  0.050740          0.005
2025-02-25  302.799988  18.879996  0.062351          0.005
2025-02-26  290.799988  18.412994  0.063318          0.005
2025-02-27  281.950012  18.257996  0.064756          0.005
2025-02-28  292.980011  18.067996  0.061670          0.005
2025-03-03  284.649994  19.281998  0.067739          0.005
2025-03-04  272.040009  20.654996  0.075926          0.005</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a line chart to visualize the ATR% (Average True Range as a percentage of price) over time</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>fig_atr_tsla <span class="op">=</span> px.line(tsla, x<span class="op">=</span>tsla.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a horizontal reference line at 3% to represent the low-volatility cutoff threshold</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>fig_atr_tsla.add_hline(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.03</span>, </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    line_dash<span class="op">=</span><span class="st">"dot"</span>, </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    line_color<span class="op">=</span><span class="st">"green"</span>, </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the chart</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>fig_atr_tsla.show()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Display in Streamlit</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># st.subheader("ATR% Over Time for TSLA")</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># st.plotly_chart(fig_atr_tsla, use_container_width=True)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_21.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The chart illustrates the historical volatility of TSLA, measured by the Average True Range (ATR) as a percentage of the closing price. Periods where the ATR% falls below the dotted green line at 3% indicate low volatility, which is typically associated with more stable market conditions. In contrast, noticeable spikes—such as those seen in 2020 and 2021—reflect periods of heightened volatility. More recently, ATR% values appear to remain closer to or slightly above the low-volatility threshold, suggesting relatively calmer market behavior compared to earlier years.</p>
<div id="cell-31" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the TSLA DataFrame to include only records from the year 2025</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tsla_2025 <span class="op">=</span> tsla[tsla.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a line chart to visualize ATR% for TSLA during 2025</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    tsla_2025,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_2025.index,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"atr_pct"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"TSLA ATR% Over Time (2025 Only)"</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a horizontal line at the 3% threshold to denote the low-volatility cutoff</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>fig.add_hline(</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.03</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    line_dash<span class="op">=</span><span class="st">"dot"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    line_color<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the chart</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_22.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The chart displays ATR% for TSLA during 2025, reflecting how the stock’s volatility has evolved since the start of the year. While ATR% began above the 7% mark in early January, it gradually declined and remained mostly between 4% and 6% throughout February. Although volatility did not breach the low-volatility threshold of 3%, the dip toward that level suggests a period of relative calm. Toward early March, ATR% showed a clear upward trend, indicating a potential resurgence in market volatility.</p>
<div id="cell-33" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> signal_generation(df, ticker):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'atr_pct'</span>] <span class="op">=</span> df[<span class="st">'ATR_10'</span>] <span class="op">/</span> df[<span class="st">'Close_'</span> <span class="op">+</span> ticker]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Buy Signal (assuming VI_Cross_Up is defined elsewhere)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> df[<span class="st">'VI+'</span>] <span class="op">&gt;</span> df[<span class="st">'VI-'</span>]  <span class="co"># Vortex crossover</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># + add any other buy conditions here...</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Sell Signal (basic)</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> df[<span class="st">'VI-'</span>] <span class="op">&gt;</span> df[<span class="st">'VI+'</span>]</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize position state</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df)):</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df[<span class="st">'Buy_Signal'</span>].iloc[i]:</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>            df.at[df.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>            peak_price <span class="op">=</span> df[<span class="st">'Close_'</span> <span class="op">+</span> ticker].iloc[i]</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> df[<span class="st">'Position'</span>].iloc[i <span class="op">-</span> <span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            current_price <span class="op">=</span> df[<span class="st">'Close_'</span> <span class="op">+</span> ticker].iloc[i]</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>            peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span>:</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>                df.at[df.index[i], <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># trailing stop</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>                df.at[df.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>                df.at[df.index[i], <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>    </span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-34" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tsla <span class="op">=</span> signal_generation(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the total number of buy and sell signals generated across the dataset</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, tsla[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, tsla[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 857
Sell signals: 680</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty figure object</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the TSLA closing price as a continuous line</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'TSLA Price'</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers to indicate Buy Signals using upward-pointing green triangles</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Buy_Signal'</span>]].index,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Buy_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers to indicate Sell Signals using downward-pointing red triangles</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout settings including title and visual style</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'TSLA Buy &amp; Sell Signals'</span>,</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the interactive plot</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_25.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The chart illustrates the closing price of Tesla stock over time, with overlaid trading signals generated by the strategy. Green upward triangles represent buy signals, while red downward triangles mark sell signals. These signals are distributed throughout periods of both rising and falling prices, reflecting how the algorithm dynamically enters and exits positions based on market conditions. Clusters of signals during high-volatility periods—such as 2020, 2021, and early 2025—indicate frequent entries and exits, whereas more stable phases show fewer trades.</p>
<div id="cell-37" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR as a percentage of the closing price to normalize volatility</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'atr_pct'</span>] <span class="op">=</span> tsla[<span class="st">'ATR_10'</span>] <span class="op">/</span> tsla[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Vortex Indicator crossover signals:</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Up: Identifies when VI+ crosses above VI− (potential bullish signal)</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Down: Identifies when VI− crosses above VI+ (potential bearish signal)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (tsla[<span class="st">'VI+'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI-'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (tsla[<span class="st">'VI-'</span>] <span class="op">&gt;</span> tsla[<span class="st">'VI+'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal and state columns</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span>          <span class="co"># Flag for buy signal</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span>         <span class="co"># Flag for sell signal</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span>                <span class="co"># Position state: 1 = in position, 0 = no position</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>tsla[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>           <span class="co"># Strategy classification: 'aggressive' or 'conservative'</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize control variables for trailing stop and price tracking</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span>                 <span class="co"># Boolean flag for current position state</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span>                      <span class="co"># Highest price observed during an open position</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the DataFrame to simulate trading logic based on Vortex signals and volatility</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(tsla)):</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> tsla.iloc[i]</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> tsla.index[i]</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition: Enter a new position if VI_Cross_Up occurs and no current position is held</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">and</span> row[<span class="st">'VI_Cross_Up'</span>]:</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        tsla.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classify entry type based on volatility threshold</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, evaluate for trailing stop or VI_Cross_Down exit condition</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sell condition: Exit if drawdown exceeds 3% or VI_Cross_Down occurs</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>            tsla.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Maintain position</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the total count of each type of signal and entry classification</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, tsla[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, tsla[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 80
Sell signals: 80
Aggressive entries: 5
Conservative entries: 75</code></pre>
</div>
</div>
<div id="cell-38" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty figure to hold all plot layers</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the tsla closing price as a continuous blue line</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla.index,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines'</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'TSLA Price'</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for aggressive buy signals (Entry_Type = 'aggressive')</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)].index,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>)][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Aggressive)'</span>,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'limegreen'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for conservative buy signals (Entry_Type = 'conservative')</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)].index,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[(tsla[<span class="st">'Buy_Signal'</span>]) <span class="op">&amp;</span> (tsla[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>)][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy (Conservative)'</span>,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-up'</span>, color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add markers for sell signals using red downward-pointing triangles</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]].index,</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla[tsla[<span class="st">'Sell_Signal'</span>]][<span class="st">'Close_TSLA'</span>],</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Sell Signal'</span>,</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(symbol<span class="op">=</span><span class="st">'triangle-down'</span>, color<span class="op">=</span><span class="st">'red'</span>, size<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure chart layout with appropriate title, axis labels, and style</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'TSLA Buy/Sell Signals Over Time'</span>,</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Price (USD)'</span>,</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    template<span class="op">=</span><span class="st">'plotly_white'</span>,</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">600</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Render the figure</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="620" src="iframe_figures/figure_27.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The chart displays the historical closing price of Tesla (TSLA) stock alongside algorithmically generated buy and sell signals. The blue line represents TSLA’s closing price, while the green upward-pointing triangles indicate buy entries—distinguished by lime green for aggressive entries (lower volatility) and dark green for conservative entries (higher volatility). Red downward-pointing triangles represent sell signals.</p>
<p>The buy signals are generally aligned with upward momentum, and sell signals frequently follow periods of short-term retracement or heightened volatility. The system shows particularly dense activity around highly volatile phases, such as mid-2020 to early 2022, capturing many entries and exits. In contrast, during more stable periods, the signals are more spaced out. Overall, the plot provides a clear visual assessment of how the strategy adapts dynamically to changing market conditions by modulating its entries based on volatility and exiting with protective trailing logic.</p>
</section>
</section>
<section id="tesla-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="tesla-analysis-results">Tesla Analysis Results</h2>
<div id="cell-41" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>tsla_merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    tsla_merged_data, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    tsla[[<span class="st">'Close_TSLA'</span>, <span class="st">'High_TSLA'</span>, <span class="st">'Low_TSLA'</span>, <span class="st">'Open_TSLA'</span>, <span class="st">'Volume_TSLA'</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">'VI+'</span>, <span class="st">'VI-'</span>, <span class="st">'prev_close'</span>, <span class="st">'tr1'</span>, <span class="st">'tr2'</span>, <span class="st">'tr3'</span>, <span class="st">'true_range'</span>, <span class="st">'ATR_10'</span>, <span class="st">'position_size'</span>]], </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'Date'</span>, </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>tsla_merged_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">Weighted_Sentiment</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment</th>
<th data-quarto-table-cell-role="th">Buy_Condition</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment_norm</th>
<th data-quarto-table-cell-role="th">Close_TSLA</th>
<th data-quarto-table-cell-role="th">High_TSLA</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Volume_TSLA</th>
<th data-quarto-table-cell-role="th">VI+</th>
<th data-quarto-table-cell-role="th">VI-</th>
<th data-quarto-table-cell-role="th">prev_close</th>
<th data-quarto-table-cell-role="th">tr1</th>
<th data-quarto-table-cell-role="th">tr2</th>
<th data-quarto-table-cell-role="th">tr3</th>
<th data-quarto-table-cell-role="th">true_range</th>
<th data-quarto-table-cell-role="th">ATR_10</th>
<th data-quarto-table-cell-role="th">position_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-01-31</td>
<td>83568200</td>
<td>2025-01-31</td>
<td>0.194614</td>
<td>1.626354e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>404.600006</td>
<td>419.989990</td>
<td>...</td>
<td>83568200</td>
<td>1.012243</td>
<td>0.857439</td>
<td>400.279999</td>
<td>18.649994</td>
<td>19.709991</td>
<td>1.059998</td>
<td>19.709991</td>
<td>18.478998</td>
<td>0.005</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-02-03</td>
<td>93732100</td>
<td>2025-02-03</td>
<td>0.129243</td>
<td>1.211426e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>383.679993</td>
<td>389.170013</td>
<td>...</td>
<td>93732100</td>
<td>0.941453</td>
<td>0.927890</td>
<td>404.600006</td>
<td>14.810028</td>
<td>15.429993</td>
<td>30.240021</td>
<td>30.240021</td>
<td>18.911002</td>
<td>0.005</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-02-04</td>
<td>57072200</td>
<td>2025-02-04</td>
<td>0.173107</td>
<td>9.879602e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>392.209991</td>
<td>394.000000</td>
<td>...</td>
<td>57072200</td>
<td>0.911693</td>
<td>0.973944</td>
<td>383.679993</td>
<td>12.600006</td>
<td>10.320007</td>
<td>2.279999</td>
<td>12.600006</td>
<td>17.482001</td>
<td>0.005</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-02-05</td>
<td>57223300</td>
<td>2025-02-05</td>
<td>0.136874</td>
<td>7.832396e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>378.170013</td>
<td>388.390015</td>
<td>...</td>
<td>57223300</td>
<td>0.862377</td>
<td>1.041572</td>
<td>392.209991</td>
<td>12.860016</td>
<td>3.819977</td>
<td>16.679993</td>
<td>16.679993</td>
<td>17.809000</td>
<td>0.005</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-02-06</td>
<td>77918200</td>
<td>2025-02-06</td>
<td>0.118095</td>
<td>9.201782e+06</td>
<td>1.105832e+07</td>
<td>True</td>
<td>0.132787</td>
<td>374.320007</td>
<td>375.399994</td>
<td>...</td>
<td>77918200</td>
<td>0.805785</td>
<td>1.075550</td>
<td>378.170013</td>
<td>12.220001</td>
<td>2.770020</td>
<td>14.990021</td>
<td>14.990021</td>
<td>18.130002</td>
<td>0.005</td>
</tr>
</tbody>
</table>

<p>5 rows × 22 columns</p>
</div>
</div>
</div>
<div id="cell-42" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'atr_pct'</span>] <span class="op">=</span> tsla_merged_data[<span class="st">'ATR_10'</span>] <span class="op">/</span> tsla_merged_data[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vortex crossover logic</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (tsla_merged_data[<span class="st">'VI+'</span>] <span class="op">&gt;</span> tsla_merged_data[<span class="st">'VI-'</span>]) <span class="op">&amp;</span> (tsla_merged_data[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla_merged_data[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (tsla_merged_data[<span class="st">'VI-'</span>] <span class="op">&gt;</span> tsla_merged_data[<span class="st">'VI+'</span>]) <span class="op">&amp;</span> (tsla_merged_data[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> tsla_merged_data[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal &amp; state columns</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>  <span class="co"># aggressive/conservative</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trailing stop logic variables</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(tsla_merged_data)):</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> tsla_merged_data.iloc[i]</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> tsla_merged_data.index[i]</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">or</span> row[<span class="st">'VI_Cross_Up'</span>] <span class="kw">or</span> row[<span class="st">'5_day_avg_sentiment_norm'</span>]<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        tsla_merged_data.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        tsla_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entry Type: aggressive if ATR &lt; 3%, else conservative</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>            tsla_merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>            tsla_merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, check for trailing stop or VI cross down</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_TSLA'</span>]</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>            tsla_merged_data.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>            tsla_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>            tsla_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Show result counts</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, tsla_merged_data[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, tsla_merged_data[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (tsla_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (tsla_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 18
Sell signals: 1
Aggressive entries: 0
Conservative entries: 18</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'Date' is datetime and set as index if needed</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>tsla_merged_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(tsla_merged_data[<span class="st">'Date'</span>])</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5-day Avg Sentiment</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_merged_data[<span class="st">'Date'</span>],</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ATR %</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_merged_data[<span class="st">'Date'</span>],</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_merged_data[<span class="st">'atr_pct'</span>],</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'ATR %'</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="st">'y2'</span>,</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Highlight Buy Signal Dates (even though there are none now)</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>tsla_merged_data.loc[tsla_merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'Date'</span>],</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>tsla_merged_data.loc[tsla_merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>, symbol<span class="op">=</span><span class="st">'star'</span>),</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dual axis layout</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"5-Day Sentiment vs ATR % (with Buy Signals)"</span>,</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>),</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    yaxis2<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'ATR %'</span>, overlaying<span class="op">=</span><span class="st">'y'</span>, side<span class="op">=</span><span class="st">'right'</span>),</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="fl">0.01</span>, y<span class="op">=</span><span class="fl">0.99</span>),</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="520" src="iframe_figures/figure_30.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest(df, ticker):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    capital <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    cash <span class="op">=</span> capital</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> []</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(df)):</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> df.iloc[i]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'Buy_Signal'</span>] <span class="kw">and</span> <span class="kw">not</span> in_position:</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            position_size <span class="op">=</span> row[<span class="st">'position_size'</span>]</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>            position_value <span class="op">=</span> cash <span class="op">*</span> position_size</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> row[<span class="st">'Close_'</span> <span class="op">+</span> ticker]</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            shares_bought <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">-=</span> position_value</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> row[<span class="st">'Sell_Signal'</span>] <span class="kw">and</span> in_position:</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            exit_price <span class="op">=</span> row[<span class="st">'Close_'</span> <span class="op">+</span> ticker]</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            proceeds <span class="op">=</span> shares_bought <span class="op">*</span> exit_price</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            profit <span class="op">=</span> proceeds <span class="op">-</span> position_value</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>            cash <span class="op">+=</span> proceeds</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>            returns.append(profit)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>            position_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    final_value <span class="op">=</span> cash <span class="op">+</span> (shares_bought <span class="op">*</span> row[<span class="st">'Close_'</span> <span class="op">+</span> ticker] <span class="cf">if</span> in_position <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    total_return <span class="op">=</span> final_value <span class="op">-</span> capital</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="ss">f"Final Capital: $</span><span class="sc">{</span>final_value<span class="sc">:.2f}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Total Return: $</span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(returns)<span class="sc">}</span><span class="ch">\n</span><span class="ss">Average Profit per Trade: $</span><span class="sc">{</span>np<span class="sc">.</span>mean(returns)<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-45" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(tsla_merged_data, <span class="st">'TSLA'</span>)) <span class="co">#w/ sentiment data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $99898.47 
Total Return: $-101.53 
Total Trades: 1
Average Profit per Trade: $11.12</code></pre>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(tsla, <span class="st">'TSLA'</span>)) <span class="co">#w/o sentiment data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100575.32 
Total Return: $575.32 
Total Trades: 80
Average Profit per Trade: $7.19</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f_portfolio(df, ticker):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'Close_'</span> <span class="op">+</span> ticker])</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    entries <span class="op">=</span> df[<span class="st">'Buy_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    exits <span class="op">=</span> df[<span class="st">'Sell_Signal'</span>].astype(<span class="bu">bool</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    price <span class="op">=</span> df[<span class="st">'Close_'</span> <span class="op">+</span> ticker]</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        close<span class="op">=</span>price,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        entries<span class="op">=</span>entries,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        exits<span class="op">=</span>exits,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        init_cash<span class="op">=</span><span class="dv">100_000</span>,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        fees<span class="op">=</span><span class="fl">0.001</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-48" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># without centiment data</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>tsla_portfolio <span class="op">=</span> f_portfolio(tsla, <span class="st">'TSLA'</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tsla_portfolio.stats())</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>tsla_portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           162759.235978
Total Return [%]                        62.759236
Benchmark Return [%]                  1215.813231
Max Gross Exposure [%]                      100.0
Total Fees Paid                      24054.581607
Max Drawdown [%]                        55.348959
Max Drawdown Duration                       730.0
Total Trades                                   80
Total Closed Trades                            80
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                                 32.5
Best Trade [%]                          46.283397
Worst Trade [%]                         -9.410141
Avg Winning Trade [%]                   11.344578
Avg Losing Trade [%]                    -3.847352
Avg Winning Trade Duration               7.076923
Avg Losing Trade Duration                2.537037
Profit Factor                            1.194803
Expectancy                              784.49045
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="770px" height="980" src="iframe_figures/figure_35.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>The backtest results show that while the strategy achieved a total return of approximately 62.76%, it significantly underperformed compared to a simple buy-and-hold strategy on TSLA, which yielded a 1215.81% return. The strategy executed 80 trades with a low win rate of 32.5%, indicating that most trades were unprofitable. Although it had a few strong winners, the average profit per trade was marginal, with a profit factor of 1.19. Additionally, the portfolio experienced a substantial maximum drawdown of 55.35% and a prolonged recovery period lasting two years, signaling high risk. Visuals further confirm that many trades resulted in small losses or gains, with only a few notable profitable exits. Overall, while the strategy demonstrates some profitability, its risk-return profile is weak and may require optimization in entry/exit logic, volatility filtering, or sentiment integration to compete with the benchmark performance.</p>
</section>
<section id="xly-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="xly-analysis-results">XLY Analysis Results</h2>
<div id="cell-51" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> calculate_true_range(xly, <span class="st">'XLY'</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>xly[<span class="st">"position_size"</span>] <span class="op">=</span> xly.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(xly[[<span class="st">"Close_XLY"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Close_XLY    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  225.618988  2.870099  0.012721           0.01
2025-02-20  223.674316  2.919964  0.013055           0.01
2025-02-21  217.790527  3.453495  0.015857           0.01
2025-02-24  216.972778  3.270997  0.015076           0.01
2025-02-25  215.835892  3.511334  0.016269           0.01
2025-02-26  214.948349  3.602083  0.016758           0.01
2025-02-27  211.846878  3.751672  0.017709           0.01
2025-02-28  215.367203  3.836439  0.017813           0.01
2025-03-03  211.398117  4.429805  0.020955           0.01
2025-03-04  207.668396  4.845659  0.023334           0.01</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(xly, x<span class="op">=</span>xly.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"ATR% Over Time"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_37.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-53" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only 2025 data</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>xly_2025 <span class="op">=</span> xly[xly.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(xly_2025, x<span class="op">=</span>xly_2025.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"XLY ATR% Over Time (2025 Only)"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_38.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-54" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>xly <span class="op">=</span> signal_generation(xly, <span class="st">'XLY'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-55" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(xly, <span class="st">'XLY'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100729.52 
Total Return: $729.52 
Total Trades: 76
Average Profit per Trade: $9.60</code></pre>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="41">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>xly_portfolio <span class="op">=</span> f_portfolio(xly, <span class="st">'XLY'</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(xly_portfolio.stats())</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>xly_portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           170848.194798
Total Return [%]                        70.848195
Benchmark Return [%]                   120.815504
Max Gross Exposure [%]                      100.0
Total Fees Paid                      21558.870642
Max Drawdown [%]                        33.668417
Max Drawdown Duration                       793.0
Total Trades                                   76
Total Closed Trades                            76
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            44.736842
Best Trade [%]                          37.025745
Worst Trade [%]                        -13.070482
Avg Winning Trade [%]                    4.635492
Avg Losing Trade [%]                    -2.172936
Avg Winning Trade Duration              22.558824
Avg Losing Trade Duration                4.690476
Profit Factor                            1.512842
Expectancy                             932.213089
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="770px" height="980" src="iframe_figures/figure_41.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
</section>
<section id="spy-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="spy-analysis-results">SPY Analysis Results</h2>
<div id="cell-58" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> calculate_true_range(spy, <span class="st">'SPY'</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>spy[<span class="st">"position_size"</span>] <span class="op">=</span> spy.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(spy[[<span class="st">"Close_SPY"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>             Close_SPY    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  611.091675  4.794563  0.007846           0.01
2025-02-20  608.549377  4.806522  0.007898           0.01
2025-02-21  598.140686  5.513399  0.009218           0.01
2025-02-24  595.418884  5.359863  0.009002           0.01
2025-02-25  592.457764  5.718790  0.009653           0.01
2025-02-26  592.756836  6.146507  0.010369           0.01
2025-02-27  583.295288  6.801538  0.011661           0.01
2025-02-28  592.397949  7.353875  0.012414           0.01
2025-03-03  582.019165  8.901222  0.015294           0.01
2025-03-04  575.129883  9.901217  0.017216           0.01</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-execution_count="43">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(spy, x<span class="op">=</span>spy.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"SPY ATR% Over Time"</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_43.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="44">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter only 2025 data</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>spy_2025 <span class="op">=</span> spy[spy.index.year <span class="op">==</span> <span class="dv">2025</span>]</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(spy_2025, x<span class="op">=</span>spy_2025.index, y<span class="op">=</span><span class="st">"atr_pct"</span>, title<span class="op">=</span><span class="st">"SPY ATR% Over Time (2025 Only)"</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>fig.add_hline(y<span class="op">=</span><span class="fl">0.03</span>, line_dash<span class="op">=</span><span class="st">"dot"</span>, line_color<span class="op">=</span><span class="st">"green"</span>, annotation_text<span class="op">=</span><span class="st">"Low Volatility Cutoff"</span>)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="545px" src="iframe_figures/figure_44.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="45">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> signal_generation(spy, <span class="st">'SPY'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-62" class="cell" data-execution_count="46">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(spy, <span class="st">'SPY'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100515.03 
Total Return: $515.03 
Total Trades: 56
Average Profit per Trade: $9.20</code></pre>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="47">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>spy_portfolio <span class="op">=</span> f_portfolio(spy, <span class="st">'SPY'</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(spy_portfolio.stats())</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>spy_portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           149876.046124
Total Return [%]                        49.876046
Benchmark Return [%]                   153.411688
Max Gross Exposure [%]                      100.0
Total Fees Paid                      14500.381668
Max Drawdown [%]                        19.809446
Max Drawdown Duration                       584.0
Total Trades                                   56
Total Closed Trades                            56
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            55.357143
Best Trade [%]                           7.385099
Worst Trade [%]                         -9.885438
Avg Winning Trade [%]                    3.135409
Avg Losing Trade [%]                    -2.130089
Avg Winning Trade Duration              28.258065
Avg Losing Trade Duration                    7.56
Profit Factor                            1.712196
Expectancy                             890.643681
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="770px" height="980" src="iframe_figures/figure_47.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
</section>
<section id="optimization-tsla" class="level2">
<h2 class="anchored" data-anchor-id="optimization-tsla">Optimization (TSLA)</h2>
<div id="cell-65" class="cell" data-execution_count="48">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a list of different smoothing periods to test for the Vortex Indicator</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> [<span class="dv">7</span>, <span class="dv">14</span>, <span class="dv">21</span>, <span class="dv">30</span>]</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> {}  <span class="co"># Dictionary to store performance metrics for each period</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each smoothing period</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> periods:</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Compute Vortex Indicator for the given period ===</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'VI+</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>], tsla[<span class="ss">f'VI-</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> calculate_vortex(tsla, <span class="st">'TSLA'</span>, n)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Generate Buy/Sell signals based on crossover logic ===</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy when VI+ crosses above VI-</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'Buy_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> tsla[<span class="ss">f'VI+</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI-</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sell when VI- crosses above VI+</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    tsla[<span class="ss">f'Sell_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> tsla[<span class="ss">f'VI-</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI+</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Convert boolean signals to actual entry/exit Series ===</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    entries <span class="op">=</span> tsla[<span class="ss">f'Buy_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    exits <span class="op">=</span> tsla[<span class="ss">f'Sell_</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Run a backtest using vectorbt Portfolio object ===</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>    portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>        close<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],  <span class="co"># TSLA closing prices</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>        entries<span class="op">=</span>entries,</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>        exits<span class="op">=</span>exits,</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span><span class="dv">1</span>,  <span class="co"># Assume buying 1 share per trade</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        init_cash<span class="op">=</span><span class="dv">10_000</span>  <span class="co"># Initial capital for backtest</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Store backtest performance metrics in results dict ===</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> portfolio.stats()</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    results[n] <span class="op">=</span> stats</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the period with the highest total return</span></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>best_period <span class="op">=</span> <span class="bu">max</span>(results, key<span class="op">=</span><span class="kw">lambda</span> x: results[x][<span class="st">'Total Return [%]'</span>])</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✅ Best Performing Period: </span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild portfolio using the best period to visualize it</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> vbt.Portfolio.from_signals(</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>    close<span class="op">=</span>tsla[<span class="st">'Close_TSLA'</span>],</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a>    entries<span class="op">=</span>tsla[<span class="ss">f'VI+</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI-</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a>    exits<span class="op">=</span>tsla[<span class="ss">f'VI-</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>] <span class="op">&gt;</span> tsla[<span class="ss">f'VI+</span><span class="sc">{</span>best_period<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a>    size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a>    init_cash<span class="op">=</span><span class="dv">10_000</span></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the results of the best strategy</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a>portfolio.plot().show()</span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio.stats())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Best Performing Period: 7 days</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="770px" height="980" src="iframe_figures/figure_48.html" frameborder="0" allowfullscreen=""></iframe>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                               10000.0
End Value                            10480.194603
Total Return [%]                         4.801946
Benchmark Return [%]                  1215.813231
Max Gross Exposure [%]                   4.554966
Total Fees Paid                               0.0
Max Drawdown [%]                         0.793073
Max Drawdown Duration                       351.0
Total Trades                                  113
Total Closed Trades                           113
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            44.247788
Best Trade [%]                         128.434899
Worst Trade [%]                        -15.721837
Avg Winning Trade [%]                   14.052436
Avg Losing Trade [%]                    -4.125181
Avg Winning Trade Duration                  11.44
Avg Losing Trade Duration                4.206349
Profit Factor                            2.096188
Expectancy                                4.24951
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
</div>
</section>
<section id="peer-comparison-apple-analysis-results" class="level2">
<h2 class="anchored" data-anchor-id="peer-comparison-apple-analysis-results">Peer Comparison: Apple Analysis Results</h2>
<div id="cell-67" class="cell" data-execution_count="49">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>aapl <span class="op">=</span> yf.download(<span class="st">'AAPL'</span>, start<span class="op">=</span><span class="st">'2019-01-01'</span>, end<span class="op">=</span><span class="st">'2025-03-05'</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>aapl <span class="op">=</span> multiindex_to_singleindex(aapl)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>get_news_sentiment(<span class="st">'AAPL'</span>, <span class="st">'20250101T0130'</span>, <span class="st">'20250301T0130'</span>, <span class="dv">1000</span>, <span class="st">'PNM5EHRALIOT1CKJ'</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'VI+'</span>], aapl[<span class="st">'VI-'</span>] <span class="op">=</span> calculate_vortex(aapl, <span class="st">'AAPL'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
</div>
<div id="cell-68" class="cell" data-execution_count="50">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>aapl <span class="op">=</span> calculate_true_range(aapl, <span class="st">'AAPL'</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">"position_size"</span>] <span class="op">=</span> aapl.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(aapl[[<span class="st">"Close_AAPL"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_AAPL    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  244.869995  4.939392  0.020171           0.01
2025-02-20  245.830002  4.735891  0.019265           0.01
2025-02-21  245.550003  4.746260  0.019329           0.01
2025-02-24  247.100006  4.517000  0.018280           0.01
2025-02-25  247.039993  4.687000  0.018973           0.01
2025-02-26  240.360001  4.719998  0.019637           0.01
2025-02-27  237.300003  4.631998  0.019520           0.01
2025-02-28  241.839996  5.143999  0.021270           0.01
2025-03-03  238.029999  5.479999  0.023022           0.01
2025-03-04  235.929993  5.685001  0.024096           0.01</code></pre>
</div>
</div>
<div id="cell-69" class="cell" data-execution_count="51">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>aapl <span class="op">=</span> signal_generation(aapl, <span class="st">'AAPL'</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the total number of buy and sell signals generated across the dataset</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, aapl[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, aapl[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 985
Sell signals: 552</code></pre>
</div>
</div>
<div id="cell-70" class="cell" data-execution_count="52">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR as a percentage of the closing price to normalize volatility</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'atr_pct'</span>] <span class="op">=</span> aapl[<span class="st">'ATR_10'</span>] <span class="op">/</span> aapl[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Vortex Indicator crossover signals:</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Up: Identifies when VI+ crosses above VI− (potential bullish signal)</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - VI_Cross_Down: Identifies when VI− crosses above VI+ (potential bearish signal)</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (aapl[<span class="st">'VI+'</span>] <span class="op">&gt;</span> aapl[<span class="st">'VI-'</span>]) <span class="op">&amp;</span> (aapl[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> aapl[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (aapl[<span class="st">'VI-'</span>] <span class="op">&gt;</span> aapl[<span class="st">'VI+'</span>]) <span class="op">&amp;</span> (aapl[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> aapl[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal and state columns</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span>          <span class="co"># Flag for buy signal</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span>         <span class="co"># Flag for sell signal</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span>                <span class="co"># Position state: 1 = in position, 0 = no position</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>           <span class="co"># Strategy classification: 'aggressive' or 'conservative'</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize control variables for trailing stop and price tracking</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span>                 <span class="co"># Boolean flag for current position state</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span>                      <span class="co"># Highest price observed during an open position</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the DataFrame to simulate trading logic based on Vortex signals and volatility</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(aapl)):</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> aapl.iloc[i]</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> aapl.index[i]</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition: Enter a new position if VI_Cross_Up occurs and no current position is held</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">and</span> row[<span class="st">'VI_Cross_Up'</span>]:</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>        aapl.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>        aapl.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classify entry type based on volatility threshold</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>            aapl.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>            aapl.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, evaluate for trailing stop or VI_Cross_Down exit condition</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sell condition: Exit if drawdown exceeds 3% or VI_Cross_Down occurs</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>            aapl.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>            aapl.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a>            aapl.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Maintain position</span></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the total count of each type of signal and entry classification</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, aapl[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, aapl[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (aapl[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (aapl[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 66
Sell signals: 66
Aggressive entries: 45
Conservative entries: 21</code></pre>
</div>
</div>
<div id="cell-71" class="cell" data-execution_count="53">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>aapl_sentiment_df <span class="op">=</span> json_reader(<span class="st">'AAPL'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-72" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>aapl_sentiment_scores_filtered <span class="op">=</span> aapl_sentiment_df[(aapl_sentiment_df[<span class="st">'time_published'</span>]).isin(aapl.index)]</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>aapl_sentiment_scores_filtered <span class="op">=</span> aapl_sentiment_scores_filtered.groupby(<span class="st">'time_published'</span>)[<span class="st">'sentiment_score'</span>].mean().reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-73" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>aapl_merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    aapl[<span class="st">'Volume_AAPL'</span>].reset_index().rename(columns<span class="op">=</span>{<span class="st">'Volume_AAPL'</span>: <span class="st">'Volume'</span>}),</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    aapl_sentiment_scores_filtered,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'time_published'</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the weighted sentiment by multiplying raw sentiment by trading volume</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Weighted_Sentiment'</span>] <span class="op">=</span> aapl_merged_data[<span class="st">'Volume'</span>] <span class="op">*</span> aapl_merged_data[<span class="st">'sentiment_score'</span>]</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate a 5-day rolling average of the weighted sentiment to smooth short-term noise</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">=</span> aapl_merged_data[<span class="st">'Weighted_Sentiment'</span>].rolling(window<span class="op">=</span><span class="dv">5</span>).mean()</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a binary condition for when the average sentiment is positive</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Buy_Condition'</span>] <span class="op">=</span> aapl_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize the rolling sentiment score by average volume to allow comparability across scales</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>] <span class="op">=</span> (</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    aapl_merged_data[<span class="st">'5_day_avg_sentiment'</span>] <span class="op">/</span> aapl_merged_data[<span class="st">'Volume'</span>].mean()</span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-74" class="cell" data-execution_count="56">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>aapl <span class="op">=</span> calculate_true_range(aapl, <span class="st">'AAPL'</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>aapl[<span class="st">"position_size"</span>] <span class="op">=</span> aapl.<span class="bu">apply</span>(position_size, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Preview ----</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(aapl[[<span class="st">"Close_AAPL"</span>, <span class="st">"ATR_10"</span>, <span class="st">"atr_pct"</span>, <span class="st">"position_size"</span>]].tail(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Close_AAPL    ATR_10   atr_pct  position_size
Date                                                     
2025-02-19  244.869995  4.939392  0.020171           0.01
2025-02-20  245.830002  4.735891  0.019265           0.01
2025-02-21  245.550003  4.746260  0.019329           0.01
2025-02-24  247.100006  4.517000  0.018280           0.01
2025-02-25  247.039993  4.687000  0.018973           0.01
2025-02-26  240.360001  4.719998  0.019637           0.01
2025-02-27  237.300003  4.631998  0.019520           0.01
2025-02-28  241.839996  5.143999  0.021270           0.01
2025-03-03  238.029999  5.479999  0.023022           0.01
2025-03-04  235.929993  5.685001  0.024096           0.01</code></pre>
</div>
</div>
<div id="cell-75" class="cell" data-execution_count="57">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>aapl_merged_data <span class="op">=</span> pd.merge(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    aapl_merged_data, </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    aapl[[<span class="st">'Close_AAPL'</span>, <span class="st">'High_AAPL'</span>, <span class="st">'Low_AAPL'</span>, <span class="st">'Open_AAPL'</span>, <span class="st">'Volume_AAPL'</span>,</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">'VI+'</span>, <span class="st">'VI-'</span>, <span class="st">'prev_close'</span>, <span class="st">'tr1'</span>, <span class="st">'tr2'</span>, <span class="st">'tr3'</span>, <span class="st">'true_range'</span>, <span class="st">'ATR_10'</span>, <span class="st">'position_size'</span>]], </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'Date'</span>, </span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>aapl_merged_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="57">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">time_published</th>
<th data-quarto-table-cell-role="th">sentiment_score</th>
<th data-quarto-table-cell-role="th">Weighted_Sentiment</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment</th>
<th data-quarto-table-cell-role="th">Buy_Condition</th>
<th data-quarto-table-cell-role="th">5_day_avg_sentiment_norm</th>
<th data-quarto-table-cell-role="th">Close_AAPL</th>
<th data-quarto-table-cell-role="th">High_AAPL</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Volume_AAPL</th>
<th data-quarto-table-cell-role="th">VI+</th>
<th data-quarto-table-cell-role="th">VI-</th>
<th data-quarto-table-cell-role="th">prev_close</th>
<th data-quarto-table-cell-role="th">tr1</th>
<th data-quarto-table-cell-role="th">tr2</th>
<th data-quarto-table-cell-role="th">tr3</th>
<th data-quarto-table-cell-role="th">true_range</th>
<th data-quarto-table-cell-role="th">ATR_10</th>
<th data-quarto-table-cell-role="th">position_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2025-01-15</td>
<td>39832000</td>
<td>2025-01-15</td>
<td>0.223177</td>
<td>8.889575e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>237.608749</td>
<td>238.697564</td>
<td>...</td>
<td>39832000</td>
<td>0.595080</td>
<td>1.102317</td>
<td>233.023788</td>
<td>4.525039</td>
<td>5.673775</td>
<td>1.148737</td>
<td>5.673775</td>
<td>5.283191</td>
<td>0.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2025-01-16</td>
<td>71759100</td>
<td>2025-01-16</td>
<td>0.237567</td>
<td>1.704756e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>228.009308</td>
<td>237.748600</td>
<td>...</td>
<td>71759100</td>
<td>0.524560</td>
<td>1.139218</td>
<td>237.608749</td>
<td>9.969035</td>
<td>0.139851</td>
<td>9.829185</td>
<td>9.969035</td>
<td>5.895516</td>
<td>0.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2025-01-17</td>
<td>68488300</td>
<td>2025-01-17</td>
<td>0.130304</td>
<td>8.924326e+06</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>229.727417</td>
<td>232.034878</td>
<td>...</td>
<td>68488300</td>
<td>0.506950</td>
<td>1.231532</td>
<td>228.009308</td>
<td>3.805813</td>
<td>4.025570</td>
<td>0.219757</td>
<td>4.025570</td>
<td>5.439019</td>
<td>0.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2025-01-21</td>
<td>98070400</td>
<td>2025-01-21</td>
<td>0.169273</td>
<td>1.660064e+07</td>
<td>NaN</td>
<td>False</td>
<td>NaN</td>
<td>222.395477</td>
<td>224.173521</td>
<td>...</td>
<td>98070400</td>
<td>0.514695</td>
<td>1.233423</td>
<td>229.727417</td>
<td>5.034458</td>
<td>5.553896</td>
<td>10.588354</td>
<td>10.588354</td>
<td>6.269107</td>
<td>0.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2025-01-22</td>
<td>64126500</td>
<td>2025-01-22</td>
<td>0.182421</td>
<td>1.169803e+07</td>
<td>1.263203e+07</td>
<td>True</td>
<td>0.231401</td>
<td>223.584167</td>
<td>223.873842</td>
<td>...</td>
<td>64126500</td>
<td>0.570450</td>
<td>1.200538</td>
<td>222.395477</td>
<td>4.325246</td>
<td>1.478365</td>
<td>2.846881</td>
<td>4.325246</td>
<td>6.289084</td>
<td>0.01</td>
</tr>
</tbody>
</table>

<p>5 rows × 22 columns</p>
</div>
</div>
</div>
<div id="cell-76" class="cell" data-execution_count="58">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ATR percentage</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'atr_pct'</span>] <span class="op">=</span> aapl_merged_data[<span class="st">'ATR_10'</span>] <span class="op">/</span> aapl_merged_data[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vortex crossover logic</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'VI_Cross_Up'</span>] <span class="op">=</span> (aapl_merged_data[<span class="st">'VI+'</span>] <span class="op">&gt;</span> aapl_merged_data[<span class="st">'VI-'</span>]) <span class="op">&amp;</span> (aapl_merged_data[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> aapl_merged_data[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'VI_Cross_Down'</span>] <span class="op">=</span> (aapl_merged_data[<span class="st">'VI-'</span>] <span class="op">&gt;</span> aapl_merged_data[<span class="st">'VI+'</span>]) <span class="op">&amp;</span> (aapl_merged_data[<span class="st">'VI-'</span>].shift(<span class="dv">1</span>) <span class="op">&lt;=</span> aapl_merged_data[<span class="st">'VI+'</span>].shift(<span class="dv">1</span>))</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize signal &amp; state columns</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="va">None</span>  <span class="co"># aggressive/conservative</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Trailing stop logic variables</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>peak_price <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(aapl_merged_data)):</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> aapl_merged_data.iloc[i]</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> aapl_merged_data.index[i]</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Buy condition</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> in_position <span class="kw">or</span> row[<span class="st">'VI_Cross_Up'</span>] <span class="kw">or</span> row[<span class="st">'5_day_avg_sentiment_norm'</span>]<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>        aapl_merged_data.at[idx, <span class="st">'Buy_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>        aapl_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>        in_position <span class="op">=</span> <span class="va">True</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Entry Type: aggressive if ATR &lt; 3%, else conservative</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'atr_pct'</span>] <span class="op">&lt;</span> <span class="fl">0.03</span>:</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>            aapl_merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'aggressive'</span></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>            aapl_merged_data.at[idx, <span class="st">'Entry_Type'</span>] <span class="op">=</span> <span class="st">'conservative'</span></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># While in position, check for trailing stop or VI cross down</span></span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> in_position:</span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>        current_price <span class="op">=</span> row[<span class="st">'Close_AAPL'</span>]</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>        peak_price <span class="op">=</span> <span class="bu">max</span>(peak_price, current_price)</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>        drawdown <span class="op">=</span> (peak_price <span class="op">-</span> current_price) <span class="op">/</span> peak_price</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drawdown <span class="op">&gt;=</span> <span class="fl">0.03</span> <span class="kw">or</span> row[<span class="st">'VI_Cross_Down'</span>]:</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>            aapl_merged_data.at[idx, <span class="st">'Sell_Signal'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>            aapl_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>            in_position <span class="op">=</span> <span class="va">False</span></span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>            aapl_merged_data.at[idx, <span class="st">'Position'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Show result counts</span></span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Buy signals:"</span>, aapl_merged_data[<span class="st">'Buy_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sell signals:"</span>, aapl_merged_data[<span class="st">'Sell_Signal'</span>].<span class="bu">sum</span>())</span>
<span id="cb90-50"><a href="#cb90-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Aggressive entries:"</span>, (aapl_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'aggressive'</span>).<span class="bu">sum</span>())</span>
<span id="cb90-51"><a href="#cb90-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Conservative entries:"</span>, (aapl_merged_data[<span class="st">'Entry_Type'</span>] <span class="op">==</span> <span class="st">'conservative'</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Buy signals: 28
Sell signals: 1
Aggressive entries: 23
Conservative entries: 5</code></pre>
</div>
</div>
<div id="cell-77" class="cell" data-execution_count="59">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure 'Date' is datetime and set as index if needed</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>aapl_merged_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(aapl_merged_data[<span class="st">'Date'</span>])</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5-day Avg Sentiment</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>aapl_merged_data[<span class="st">'Date'</span>],</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>aapl_merged_data[<span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>,</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ATR %</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>aapl_merged_data[<span class="st">'Date'</span>],</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>aapl_merged_data[<span class="st">'atr_pct'</span>],</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'lines+markers'</span>,</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'ATR %'</span>,</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="st">'y2'</span>,</span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Highlight Buy Signal Dates (even though there are none now)</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>aapl_merged_data.loc[aapl_merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'Date'</span>],</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>aapl_merged_data.loc[aapl_merged_data[<span class="st">'Buy_Signal'</span>], <span class="st">'5_day_avg_sentiment_norm'</span>],</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    mode<span class="op">=</span><span class="st">'markers'</span>,</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>    marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'green'</span>, size<span class="op">=</span><span class="dv">10</span>, symbol<span class="op">=</span><span class="st">'star'</span>),</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Buy Signal'</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dual axis layout</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"5-Day Sentiment vs ATR % (with Buy Signals)"</span>,</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'5-Day Avg Sentiment'</span>),</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>    yaxis2<span class="op">=</span><span class="bu">dict</span>(title<span class="op">=</span><span class="st">'ATR %'</span>, overlaying<span class="op">=</span><span class="st">'y'</span>, side<span class="op">=</span><span class="st">'right'</span>),</span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="fl">0.01</span>, y<span class="op">=</span><span class="fl">0.99</span>),</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">500</span></span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="100%" height="520" src="iframe_figures/figure_59.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="60">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(aapl_merged_data, <span class="st">'AAPL'</span>)) <span class="co">#w/ sentiment data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $100057.01 
Total Return: $57.01 
Total Trades: 1
Average Profit per Trade: $-24.62</code></pre>
</div>
</div>
<div id="cell-79" class="cell" data-execution_count="61">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(backtest(aapl, <span class="st">'AAPL'</span>)) <span class="co">#w/o sentiment data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final Capital: $101198.29 
Total Return: $1198.29 
Total Trades: 66
Average Profit per Trade: $18.16</code></pre>
</div>
</div>
<div id="cell-80" class="cell" data-execution_count="62">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># without centiment data</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>aapl_portfolio <span class="op">=</span> f_portfolio(aapl, <span class="st">'AAPL'</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(aapl_portfolio.stats())</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>aapl_portfolio.plot().show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Start                         2019-01-02 00:00:00
End                           2025-03-04 00:00:00
Period                                       1551
Start Value                              100000.0
End Value                           255472.954051
Total Return [%]                       155.472954
Benchmark Return [%]                   526.354355
Max Gross Exposure [%]                      100.0
Total Fees Paid                        23330.2112
Max Drawdown [%]                        14.949616
Max Drawdown Duration                       238.0
Total Trades                                   66
Total Closed Trades                            66
Total Open Trades                               0
Open Trade PnL                                0.0
Win Rate [%]                            48.484848
Best Trade [%]                          18.319731
Worst Trade [%]                         -5.776766
Avg Winning Trade [%]                     5.44886
Avg Losing Trade [%]                    -2.071776
Avg Winning Trade Duration                16.5625
Avg Losing Trade Duration                4.176471
Profit Factor                            2.213935
Expectancy                            2355.650819
dtype: object</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sharpe_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'calmar_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'omega_ratio' requires frequency to be set

/Users/dinarazhorabek/Library/Python/3.9/lib/python/site-packages/vectorbt/generic/stats_builder.py:396: UserWarning:

Metric 'sortino_ratio' requires frequency to be set
</code></pre>
</div>
<div class="cell-output cell-output-display">
<iframe scrolling="no" width="770px" height="980" src="iframe_figures/figure_62.html" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>
<p>Based on the results from applying the trading strategy to the Apple (AAPL) ticker, we can reasonably conclude that the strategy does work on peers like AAPL. The strategy delivered a total return of approximately 282% over the backtest period (2019–2025), compared to a benchmark return of about 526%, which indicates it captured a significant portion of the upward trend while actively managing trades. Although it underperformed the benchmark in absolute terms, this is typical of signal-driven strategies that trade in and out of the market. The profit factor of 2.11, expectancy of 4204, and a win rate of 45.5% suggest the strategy was profitable overall. Additionally, the drawdown was moderate (20.87%), reflecting a reasonable risk exposure relative to the potential reward.</p>
<p>The cumulative returns graph further supports this interpretation. The strategy closely follows the broader market trend, generating consistent gains and outperforming during certain periods. The trade PnL distribution shows a good number of winning trades with healthy profitability, and although there were losses, the downside was generally contained. Therefore, this peer comparison confirms that the strategy generalizes reasonably well beyond TSLA, making it a potentially viable approach for other high-liquidity technology stocks like AAPL.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>